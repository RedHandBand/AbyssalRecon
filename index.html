<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abyssal Recon: Tactical Command</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap');
        
        body {
            background-color: #0f172a;
            color: #e2e8f0;
            font-family: 'Space Mono', monospace;
            user-select: none;
            overflow-x: hidden;
        }

        #game-grid, #overworld-grid {
            display: grid;
        }

        .grid-cell {
            aspect-ratio: 1 / 1;
            transition: all 0.15s ease;
            font-size: 0.75rem;
            position: relative;
        }

        .cell-hidden {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
        }

        .cell-hidden:hover {
            background: #334155;
            cursor: crosshair;
        }

        .cell-revealed-water {
            background: #0c4a6e;
            color: #7dd3fc;
        }

        .cell-revealed-ship {
            background: #991b1b;
            animation: hit-shake 0.3s ease-in-out;
            z-index: 10;
        }

        .cell-sunk-ship {
            background: #450a0a !important;
            color: #ef4444 !important;
            filter: grayscale(0.2);
        }

        .cell-merchant {
            z-index: 40;
            filter: drop-shadow(0 0 8px #fff);
            animation: pulse-border 2s infinite;
        }

        @keyframes pulse-border {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes hit-shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }

        .cell-sonar {
            background: #065f46 !important;
            box-shadow: inset 0 0 10px #10b981;
            z-index: 20;
        }

        .cell-sonar-preview {
            background-color: rgba(16, 185, 129, 0.25) !important;
            box-shadow: inset 0 0 8px rgba(16, 185, 129, 0.4);
        }

        .cell-torpedo-path {
            background: #f59e0b !important;
            box-shadow: 0 0 10px #f59e0b;
            z-index: 20;
        }

        .cell-buster-path {
            background: #ef4444 !important;
            box-shadow: 0 0 20px #ef4444;
            z-index: 20;
        }

        .fog-overlay {
            position: absolute;
            inset: 0;
            background: rgba(148, 163, 184, 0.3);
            backdrop-filter: blur(4px);
            pointer-events: none;
            z-index: 5;
            animation: fog-pulse 6s ease-in-out infinite;
        }

        @keyframes fog-pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 0.8; }
        }

        .radar-sweep {
            position: absolute;
            width: 100%;
            height: 2px;
            background: rgba(16, 185, 129, 0.1);
            top: 0;
            animation: sweep 6s linear infinite;
            pointer-events: none;
            z-index: 30;
        }

        @keyframes sweep {
            from { top: 0; }
            to { top: 100%; }
        }

        .weapon-active {
            border-color: white !important;
            box-shadow: 0 0 15px rgba(255,255,255,0.4);
            transform: translateY(-2px);
        }

        .ship-indicator {
            display: flex; gap: 2px; padding: 4px; background: rgba(30, 41, 59, 0.5); border-radius: 4px; border: 1px solid transparent;
        }
        
        .ship-segment {
            width: 8px; height: 12px; background: #475569; border-radius: 1px;
        }

        .ship-sunk .ship-segment { background: #ef4444; opacity: 0.3; }
        .ship-sunk { position: relative; border-color: #ef444433 !important; }
        .ship-sunk::after { content: ''; position: absolute; left: 0; top: 50%; width: 100%; height: 2px; background: #ef4444; transform: rotate(-5deg); }

        .weather-card {
            background: linear-gradient(to bottom, #1e293b, #0f172a);
            border-left: 4px solid #3b82f6;
        }

        .sub-card, .reward-card {
            transition: all 0.3s; cursor: pointer; border: 1px solid #334155;
        }
        .sub-card:hover, .reward-card:hover {
            background: #1e293b; border-color: #10b981; transform: translateY(-5px);
        }
        
        .stat-row {
            display: flex; justify-content: space-between; font-size: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); padding: 2px 0;
        }

        .map-tile {
            aspect-ratio: 1 / 1; border: 1px solid #334155; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: all 0.3s; position: relative; overflow: hidden;
        }
        .tile-hq { background: #064e3b; border-color: #10b981; }
        .tile-mission { background: #1e293b; cursor: pointer; }
        .tile-mission:hover { background: #334155; border-color: #fbbf24; }
        .tile-locked { background: #0f172a; opacity: 0.5; color: #475569; }
        .tile-current { box-shadow: inset 0 0 15px #10b981; border-color: #10b981; z-index: 10; }
        .tile-visited { background: #0f172a; border-color: #1e293b; opacity: 0.8; }
        .tile-rift { background: #4c1d95; border-color: #a78bfa; animation: pulse-rift 4s infinite; cursor: pointer; }
        
        .tile-mission-early { background: #1e293b; border-color: #334155; cursor: pointer; }
        .tile-mission-mid { background: #1e1b4b; border-color: #4f46e5; cursor: pointer; }
        .tile-mission-late { background: #2e1065; border-color: #7c3aed; cursor: pointer; }

        @keyframes pulse-rift { 0%, 100% { box-shadow: 0 0 5px #a78bfa; } 50% { box-shadow: 0 0 20px #a78bfa; } }
        .glitch-text { text-shadow: 2px 2px #ef4444, -2px -2px #3b82f6; }

        #tooltip {
            position: fixed; z-index: 200; background: #1e293b; border: 1px solid #334155; padding: 8px 12px; border-radius: 4px; font-size: 10px; max-width: 200px; pointer-events: none; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); display: none; line-height: 1.4;
        }

        #battle-log::-webkit-scrollbar { width: 4px; }
        #battle-log::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }
        .log-entry { border-left: 2px solid transparent; animation: slide-in 0.2s ease-out; }
        @keyframes slide-in { from { opacity: 0; transform: translateX(10px); } to { opacity: 1; transform: translateX(0); } }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <div id="tooltip"></div>

    <!-- Screen 0: Title Screen -->
    <div id="title-screen" class="min-h-screen w-full flex flex-col items-center justify-center text-center px-4">
        <div class="mb-16 relative">
            <div class="absolute -inset-10 bg-emerald-500/10 blur-3xl rounded-full"></div>
            <h1 class="text-7xl font-black text-emerald-500 uppercase tracking-tighter italic glitch-text mb-2 text-wrap break-words max-w-full font-mono">Abyssal Recon</h1>
            <p class="text-slate-400 font-bold tracking-[0.5em] text-sm uppercase font-mono">Deduction-Based Naval Warfare</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full max-w-2xl font-mono">
            <button onclick="initCampaign()" class="group relative bg-slate-900 border border-emerald-500/50 p-8 rounded-xl text-left transition-all hover:bg-slate-800 hover:scale-105 shadow-xl">
                <div class="absolute top-4 right-4 text-[10px] bg-emerald-900 text-emerald-400 px-2 py-1 rounded font-bold uppercase tracking-widest">The Hunt</div>
                <h2 class="text-2xl font-black text-emerald-400 uppercase mb-2">Campaign</h2>
                <p class="text-xs text-slate-400 leading-relaxed">Navigate the Benthic Survey Map, claim permanent upgrades, and neutralize the Rift.</p>
                <div class="mt-6 flex items-center gap-2 text-emerald-500 font-bold text-[10px] uppercase tracking-widest group-hover:gap-4 transition-all">Start Survey <span>‚Üí</span></div>
            </button>

            <button onclick="initArcade()" class="group relative bg-slate-900 border border-slate-700 p-8 rounded-xl text-left transition-all hover:bg-slate-800 hover:border-blue-500/50 hover:scale-105 shadow-xl">
                <h2 class="text-2xl font-black text-blue-400 uppercase mb-2">Arcade</h2>
                <p class="text-xs text-slate-400 leading-relaxed">Single deployment scenario. Cleanse a random sector of hostile presence.</p>
                <div class="mt-6 flex items-center gap-2 text-blue-500 font-bold text-[10px] uppercase tracking-widest group-hover:gap-4 transition-all">Quick Deployment <span>‚Üí</span></div>
            </button>
        </div>

        <div class="mt-16 text-[10px] text-slate-600 uppercase tracking-widest font-bold border-t border-slate-800 pt-4 font-mono">Command Center v5.18 // Action Logic Restored</div>
    </div>

    <!-- Screen 1: Benthic Survey Map -->
    <div id="overworld-screen" class="hidden max-w-4xl w-full flex flex-col items-center py-10">
        <div class="text-center mb-8 px-4 font-mono">
            <h1 class="text-4xl font-black text-emerald-500 uppercase tracking-tighter italic font-mono">Benthic Survey Map</h1>
            <p class="text-slate-500 font-bold tracking-widest text-xs mt-2 uppercase font-mono">Sub-Surface Operational Matrix</p>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 w-full">
            <div class="lg:col-span-2"><div id="overworld-grid" class="grid grid-cols-5 gap-2 w-full bg-slate-900 p-4 rounded-xl border border-slate-800 shadow-2xl"></div></div>
            <div class="lg:col-span-1 space-y-4 font-mono">
                <div class="bg-slate-900/80 border border-emerald-500/30 p-4 rounded-lg shadow-xl font-mono">
                    <h2 class="text-[10px] font-black text-emerald-400 uppercase mb-3 border-b border-emerald-900/50 pb-1 uppercase tracking-widest font-mono">Abyssal Dossier</h2>
                    <div id="intel-echo-list" class="space-y-2 max-h-60 overflow-y-auto pr-2 text-[10px] text-slate-400 leading-tight italic font-mono">
                        <p>Sector clears reveal Arcane Echoes...</p>
                    </div>
                </div>
                <div class="bg-slate-800/50 p-4 rounded border border-slate-700 font-mono">
                    <p class="text-[10px] text-slate-400 uppercase font-bold mb-1 tracking-widest uppercase font-mono">Fleet Upgrades</p>
                    <div id="active-upgrades-list" class="text-[9px] text-emerald-400 font-bold space-y-1 text-wrap font-mono">None</div>
                </div>
                <div class="bg-slate-800/50 p-4 rounded border border-slate-700 flex justify-between items-center font-mono">
                    <div><p class="text-[10px] text-slate-400 uppercase font-bold uppercase tracking-widest font-mono">Salvage</p><div id="salvaged-ammo-display" class="text-xl font-bold text-amber-500 leading-none font-mono">0</div></div>
                    <button onclick="mainMenu()" class="text-[9px] text-slate-500 hover:text-red-400 transition-colors uppercase font-bold tracking-widest border border-slate-700 px-3 py-1 rounded italic font-mono">Abort</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Screen 2: Reward Choice -->
    <div id="reward-screen" class="hidden max-w-4xl w-full flex flex-col items-center py-10 px-4 font-mono">
        <div class="text-center mb-10 font-mono"><h1 class="text-4xl font-black text-amber-500 uppercase tracking-tighter italic font-mono">Echoes Recovered</h1><p class="text-slate-500 font-bold tracking-widest text-xs mt-2 uppercase font-mono">Tactical Salvage Identified</p></div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 w-full mb-8 font-mono" id="reward-options-container"></div>
        <div class="flex flex-col items-center gap-4 font-mono"><button id="reroll-btn" onclick="rerollRewards()" class="bg-slate-800 hover:bg-slate-700 border border-amber-500/50 px-8 py-3 rounded-full font-bold text-xs uppercase tracking-widest transition-all font-mono">Reroll (Cost: <span id="reroll-cost">1</span> Ammo)</button></div>
    </div>

    <!-- Screen 3: Deployment Phase -->
    <div id="deployment-screen" class="hidden max-w-5xl w-full flex flex-col items-center py-10 px-4 font-mono">
        <div class="text-center mb-10 font-mono"><h1 id="brief-title" class="text-4xl font-black text-emerald-500 uppercase tracking-tighter italic font-mono">Mission Briefing</h1><p id="mission-coord-display" class="text-slate-500 font-bold tracking-widest text-xs mt-2 uppercase font-mono">Sector [0,0]</p></div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 w-full font-mono">
            <div class="md:col-span-1 bg-slate-900 border border-slate-700 p-6 rounded-lg self-start text-left font-mono">
                <h2 class="text-emerald-400 font-bold uppercase text-sm mb-4 border-b border-slate-700 pb-2 tracking-widest uppercase font-mono">Tactical Intel</h2>
                <div class="space-y-4 font-mono">
                    <div><p class="text-[10px] text-slate-500 uppercase tracking-widest font-mono">Environment</p><p id="brief-weather" class="text-sm font-bold text-blue-400 uppercase font-mono">Clear Skies</p></div>
                    <div><p class="text-[10px] text-slate-500 uppercase tracking-widest font-mono">Signatures</p><p id="brief-fleet" class="text-sm font-bold text-red-400 uppercase font-mono tracking-tighter font-mono">7 Confirmed</p></div>
                    <div><p class="text-[10px] text-slate-500 uppercase tracking-widest font-mono">Objective</p><p id="brief-objective" class="text-[10px] text-slate-400 italic font-mono">"Intercept hostiles."</p></div>
                </div>
                <button id="return-map-btn" class="mt-6 w-full py-2 border border-slate-700 rounded text-[10px] uppercase font-bold hover:bg-slate-800 font-mono">Return to Map</button>
            </div>
            <div class="md:col-span-2 space-y-4 text-center md:text-left font-mono">
                <h2 class="text-slate-300 font-bold uppercase text-sm mb-2 uppercase tracking-widest font-mono">Select Asset</h2>
                <div id="sub-selection-container" class="grid grid-cols-1 sm:grid-cols-2 gap-4 font-mono"></div>
            </div>
        </div>
    </div>

    <!-- Screen 4: Tactical Interface -->
    <div id="game-screen" class="hidden max-w-6xl w-full py-6 px-4 font-mono">
        <div class="mb-4 max-w-3xl mx-auto font-mono">
            <div class="flex justify-between items-end border-b border-slate-700 pb-2 font-mono">
                <div><h1 id="sub-name-display" class="text-2xl font-bold text-emerald-500 uppercase tracking-tighter font-mono">Nautilus</h1><p id="mode-tag-display" class="text-[10px] text-slate-400 font-bold tracking-widest uppercase italic font-mono">DEPLOYED</p></div>
                <div class="text-right">
                    <div class="text-xl font-bold flex items-center justify-end gap-2 font-mono"><span id="shots-count">30</span><svg class="w-5 h-5 text-orange-500" fill="currentColor" viewBox="0 0 24 24"><path d="M12,2L4.5,20.29L5.21,21L12,18L18.79,21L19.5,20.29L12,2Z"/></svg></div>
                    <div class="text-[10px] uppercase text-slate-500 tracking-widest font-bold font-mono">Ammunition</div>
                </div>
            </div>
            <div id="fleet-dashboard" class="flex flex-wrap gap-3 mt-3 bg-slate-900/50 p-3 rounded border border-slate-800 font-mono"></div>
            <div id="merchant-status-panel" class="hidden mt-3 bg-slate-800 p-2 rounded border border-white/20 flex items-center justify-between font-mono">
                <div class="flex items-center gap-2 font-mono"><span class="text-xl">üö¢</span><span class="text-[10px] font-bold uppercase tracking-widest font-mono">Freight Integrity</span></div>
                <div class="flex-1 mx-4 bg-slate-900 h-3 rounded-full border border-slate-700 overflow-hidden font-mono"><div id="merchant-health-bar" class="h-full bg-emerald-500 transition-all duration-500 font-mono" style="width: 100%"></div></div>
                <div id="merchant-health-text" class="text-xs font-bold font-mono font-mono">5/5</div>
            </div>
            <div class="grid grid-cols-7 gap-2 mt-3 font-mono">
                <div class="weather-card p-2 rounded border border-slate-700 flex flex-col justify-center col-span-2 font-mono">
                    <div class="text-[10px] text-slate-400 uppercase font-bold tracking-tighter uppercase font-mono font-mono">Condition</div>
                    <div id="weather-text" class="text-xs font-bold text-blue-400 uppercase font-mono font-mono">Clear Skies</div>
                    <div id="next-weather" class="text-[9px] font-bold text-slate-500 uppercase mt-1 tracking-tight font-mono font-mono">Forecast: Loading...</div>
                </div>
                <button id="sonar-btn" onclick="activateSonar()" class="bg-emerald-900/50 hover:bg-emerald-800 p-2 rounded border border-emerald-700 transition-all disabled:opacity-30 col-span-1 font-mono">
                    <div class="text-[10px] text-emerald-300 uppercase font-mono">Sonar</div>
                    <div id="sonar-count" class="text-lg font-bold text-emerald-400 font-mono font-mono">3</div>
                </button>
                <button id="torpedo-btn" onclick="activateTorpedo()" class="bg-amber-900/50 hover:bg-amber-800 p-2 rounded border border-amber-700 transition-all col-span-1 font-mono">
                    <div class="text-[10px] text-amber-300 uppercase font-mono">Torp</div>
                    <div id="torpedo-count" class="text-lg font-bold text-amber-400 font-mono font-mono">2</div>
                </button>
                <button id="buster-btn" onclick="activateBuster()" class="bg-red-900/30 hover:bg-red-900/50 p-2 rounded border border-red-900 transition-all col-span-1 disabled:opacity-20 font-mono">
                    <div class="text-[10px] text-red-400 uppercase font-mono font-mono">Buster</div>
                    <div id="buster-count" class="text-lg font-bold text-red-500 font-mono font-mono">0</div>
                </button>
                <button id="advance-btn" onclick="signalAdvanceTurn()" class="hidden bg-slate-700 hover:bg-slate-600 p-2 rounded border border-white/20 transition-all col-span-1 font-mono">
                    <div class="text-[10px] text-slate-300 uppercase font-mono">Signal</div>
                    <div class="text-xs font-bold text-white uppercase font-mono font-mono">Advance</div>
                </button>
                <div class="bg-slate-800 p-2 rounded border border-slate-700 flex flex-col justify-between col-span-1 font-mono">
                    <div><div class="text-[10px] text-slate-400 uppercase font-bold font-mono font-mono font-mono">Hull Hits</div><div id="fleet-count" class="text-xs font-bold text-red-400 tracking-tighter font-mono font-mono">0/0</div></div>
                    <div><div id="status-text" class="text-[9px] font-bold text-emerald-500 uppercase tracking-tighter font-mono font-mono">Ready</div></div>
                </div>
            </div>
        </div>
        <div class="flex flex-col lg:flex-row items-start justify-center gap-6 font-mono">
            <div class="relative p-1 bg-slate-800 rounded shadow-2xl border border-slate-700 overflow-hidden font-mono">
                <div class="radar-sweep font-mono"></div>
                <div id="game-grid" class="gap-px bg-slate-900 border border-slate-900 font-mono" style="width: min(95vw, 600px);"></div>
                <div id="dir-selector" class="hidden absolute inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm font-mono">
                    <div class="bg-slate-800 p-4 rounded-lg border border-amber-500 shadow-2xl text-center font-mono">
                        <p id="target-vector-text" class="text-amber-500 font-bold mb-4 uppercase text-sm font-mono">Target Vector</p>
                        <div class="grid grid-cols-3 gap-2 font-mono">
                            <div></div><button id="btn-up" class="p-3 bg-slate-700 hover:bg-amber-600 rounded font-mono">‚ñ≤</button><div></div>
                            <button id="btn-left" class="p-3 bg-slate-700 hover:bg-amber-600 rounded font-mono">‚óÄ</button>
                            <button onclick="cancelWeapon()" class="p-3 bg-red-900/50 hover:bg-red-600 rounded text-xs font-mono font-bold font-mono">X</button>
                            <button id="btn-right" class="p-3 bg-slate-700 hover:bg-amber-600 rounded font-mono">‚ñ∂</button>
                            <div></div><button id="btn-down" class="p-3 bg-slate-700 hover:bg-amber-600 rounded font-mono">‚ñº</button><div></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="w-full lg:w-80 h-[300px] lg:h-[608px] bg-slate-900/80 border border-slate-700 rounded-lg flex flex-col shadow-2xl font-mono">
                <div class="p-3 border-b border-slate-700 bg-slate-800/50 flex justify-between items-center text-center font-mono"><h2 class="text-[10px] font-black text-slate-400 uppercase tracking-widest flex items-center gap-2 font-mono font-mono font-mono"><span class="w-2 h-2 bg-red-500 rounded-full animate-pulse font-mono font-mono font-mono"></span>Telemetry Feed</h2></div>
                <div id="battle-log" class="flex-1 overflow-y-auto p-4 space-y-3 font-mono"></div>
            </div>
        </div>
        <div class="mt-8 flex flex-col items-center gap-4 font-mono"><button onclick="abortMatch()" class="btn-abort text-[10px] px-8 py-2 rounded font-bold text-red-400 uppercase tracking-widest border border-red-900/30 italic font-mono">Abort Survey</button></div>
    </div>

    <div id="overlay" class="hidden fixed inset-0 bg-slate-900/95 flex flex-col items-center justify-center z-[100] p-6 text-center font-mono">
        <h2 id="overlay-title" class="text-6xl font-black mb-4 tracking-tighter uppercase font-mono">DEFEAT</h2>
        <p id="overlay-msg" class="text-xl text-slate-400 mb-8 max-w-md italic font-mono"></p>
        <div class="flex gap-4 font-mono">
            <button id="end-action-btn" class="bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-4 px-12 rounded-full transition-all transform hover:scale-105 shadow-lg shadow-emerald-900/20 uppercase tracking-widest italic font-mono">Main Menu</button>
            <button id="secondary-action-btn" class="hidden bg-red-900/50 hover:bg-red-800 text-red-200 font-bold py-4 px-12 rounded-full transition-all border border-red-700 uppercase tracking-widest italic font-mono">Abandon</button>
        </div>
    </div>

    <script>
        // --- UTILITIES ---
        function getNumberColor(n) { return ['', '#60a5fa', '#4ade80', '#fbbf24', '#f87171', '#c084fc', '#2dd4bf', '#f472b6', '#ffffff'][n] || '#fff'; }
        
        function showScreen(screenId) {
            ['title', 'overworld', 'deployment', 'game', 'reward'].forEach(s => document.getElementById(`${s}-screen`)?.classList.add('hidden'));
            document.getElementById(`${screenId}-screen`)?.classList.remove('hidden');
            if (screenId === 'overworld') renderOverworld();
            if (screenId === 'reward') generateRewards();
        }

        function getTileClass(r, c) {
            const s = mapData[r][c].status, m = mapMissionTypes[r][c], dist = r + c;
            if (m === 'RIFT' && s === 'mission') return 'tile-rift';
            if (s === 'current') return 'tile-hq tile-current';
            if (s === 'mission') {
                if (dist <= 2) return 'tile-mission-early';
                if (dist <= 5) return 'tile-mission-mid';
                return 'tile-mission-late';
            }
            if (s === 'visited') return 'tile-visited';
            return 'tile-locked';
        }

        function isAdjacentToVisited(r, c) { return [[r-1, c], [r+1, c], [r, c-1], [r, c+1]].some(([nr, nc]) => nr >= 0 && nr < 5 && nc >= 0 && nc < 5 && (mapData[nr][nc].status === 'visited' || mapData[nr][nc].status === 'current')); }

        function isLinear(coords) {
            if (coords.length <= 1) return true;
            const r0 = coords[0].r, c0 = coords[0].c;
            const sameRow = coords.every(p => p.r === r0);
            const sameCol = coords.every(p => p.c === c0);
            return sameRow || sameCol;
        }

        function logEvent(msg, type = 'info') {
            const logContainer = document.getElementById('battle-log'); if (!logContainer) return;
            const colors = { 'info': 'text-blue-400', 'hit': 'text-red-500', 'miss': 'text-slate-500', 'salvage': 'text-emerald-400', 'weapon': 'text-amber-500', 'warning': 'text-orange-500 font-bold' };
            const entry = document.createElement('div'); entry.className = `log-entry p-2 bg-slate-950/40 rounded text-[10px] ${colors[type] || colors.info}`;
            const ts = new Date().toLocaleTimeString([], { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
            entry.innerHTML = `<span class="text-[8px] opacity-30 mr-2 font-mono">${ts}</span> ${msg}`;
            logContainer.prepend(entry);
        }

        function initTooltips() {
            const t = document.getElementById('tooltip');
            document.addEventListener('mouseover', e => {
                const target = e.target.closest('.keyword');
                if (target) { const text = target.innerText.toUpperCase(); if (TOOLTIPS[text]) { t.innerText = TOOLTIPS[text]; t.style.display = 'block'; } }
                const tile = e.target.closest('.map-tile');
                if(tile && tile.dataset.hint) { t.innerText = "ARCANE ECHO: " + tile.dataset.hint; t.style.display = 'block'; }
            });
            document.addEventListener('mousemove', e => { if (t.style.display === 'block') { t.style.left = (e.clientX + 15) + 'px'; t.style.top = (e.clientY + 15) + 'px'; } });
            document.addEventListener('mouseout', e => { if (e.target.closest('.keyword') || e.target.closest('.map-tile')) t.style.display = 'none'; });
        }

        function generateRiftHint() {
            const type = Math.random();
            if (type < 0.3) {
                const vert = riftPos.r > playerPos.r ? "South" : (riftPos.r < playerPos.r ? "North" : "same latitude");
                return `Rift detected ${vert} of this position.`;
            } else if (type < 0.6) {
                const horiz = riftPos.c > playerPos.c ? "East" : (riftPos.c < playerPos.c ? "West" : "same longitude");
                return `Arcane pings suggest the Rift lies to the ${horiz}.`;
            } else {
                const d = Math.abs(riftPos.r - playerPos.r) + Math.abs(riftPos.c - playerPos.c);
                return `Rift approx. ${d} sectors away.`;
            }
        }

        // --- CONFIGS ---
        const GRID_SIZE = 15;
        const BASE_FLEET = [5, 4, 4, 3, 3, 2, 2];
        const BOSS_FLEET = [5, 3, 3, 3, 2, 2, 2];
        const WEATHER_TYPES = ['Clear Skies', 'Dense Fog', 'Electrical Storm', 'Rough Seas'];
        const UPGRADES = [
            { id: 'ammo_1', name: 'Ammo I', desc: 'Starting ammo +5', bonus: { shots: 5 }, req: null },
            { id: 'ammo_2', name: 'Ammo II', desc: 'Starting ammo +10', bonus: { shots: 10 }, req: 'ammo_1' },
            { id: 'torp_1', name: 'Firepower I', desc: 'Starting torpedoes +1', bonus: { torps: 1 }, req: null },
            { id: 'torp_2', name: 'Firepower II', desc: 'Starting torpedoes +2', bonus: { torps: 2 }, req: 'torp_1' },
            { id: 'sonar_1', name: 'Knowledge I', desc: 'Starting sonar +1', bonus: { sonar: 1 }, req: null },
            { id: 'sonar_2', name: 'Knowledge II', desc: 'Starting sonar +2', bonus: { sonar: 2 }, req: 'sonar_1' },
            { id: 'buster_1', name: 'Buster I', desc: 'Torpedoes cost 1 ammo', bonus: { torpCost: 1 }, req: null },
            { id: 'buster_2', name: 'Buster II', desc: 'Torpedoes cost 0 ammo', bonus: { torpCost: 0 }, req: 'buster_1' },
            { id: 'eff_1', name: 'Efficient I', desc: 'Hits recharge 1 ammo', bonus: { hitRefund: 1 }, req: null },
            { id: 'eff_2', name: 'Efficient II', desc: 'Hits recharge 2 ammo', bonus: { hitRefund: 2 }, req: 'eff_1' },
            { id: 'drone_1', name: 'Drones I', desc: 'Sonar scans 4x4 area', bonus: { sonarSize: 4 }, req: null },
            { id: 'drone_2', name: 'Drones II', desc: 'Sonar strikes scanned ships', bonus: { sonarAggressive: true }, req: 'drone_1' },
            { id: 'intercept_1', name: 'Intercept I', desc: 'Radar Vessels reveal 2 tiles', bonus: { intelBonus: 2 }, req: null },
            { id: 'intercept_2', name: 'Intercept II', desc: 'Radar Vessels reveal 3 tiles', bonus: { intelBonus: 3 }, req: 'intercept_1' }
        ];
        const ALIEN_SHAPES = {
            2: [[[0,0], [1,0]], [[0,0], [0,1]]],
            3: [ [[0,0], [0,1], [1,0]], [[0,0], [0,1], [-1,0]], [[0,0], [1,0], [1,1]], [[0,0], [0,-1], [1,0]] ],
            4: [ [[0,0], [0,1], [1,1], [1,2]], [[0,0], [0,1], [0,2], [1,1]], [[0,0], [0,1], [1,0], [1,1]], [[0,0], [1,0], [2,0], [2,1]] ],
            5: [ [[0,0], [0,1], [0,2], [1,0], [2,0]], [[0,0], [1,0], [2,0], [1,1], [1,2]], [[0,0], [0,1], [1,1], [2,1], [2,0]] ]
        };
        const BOSS_CORE_SHAPE = [[0,0], [1,0], [-1,0], [0,1], [0,-1]]; 
        const TOOLTIPS = {
            'ELECTRICAL STORM': 'Sonar Jamming active. Knowledge tools disabled (unless using Ghost-6).',
            'ROUGH SEAS': 'Turbulent waters detected. Torpedo range reduced to 5 slots.',
            'DENSE FOG': 'Visibility critical. Ship proximity data obscured (Reveals \'?\' instead of counts).',
            'CLEAR SKIES': 'Optimal operating conditions. All systems functioning at peak efficiency.',
            'ARCANE STORM': 'Phasing anomaly. Conditions alternate between Sonar Jamming and Range Limitation.',
            'UNSTABLE PHASING': 'The Rift cycles conditions every 8 turns.',
            'REGENERATIVE': 'Hostile entity can heal partially damaged components if not fully neutralized quickly.'
        };

        // --- SOUND ENGINE ---
        const Sound = (function() {
            let ctx = null, noiseBuffer = null;
            let bgmNodes = { drone: null, tension: null, melody: null, dGain: null, tGain: null, mGain: null, filter: null };
            let musicStarted = false;
            let musicInterval = null;

            function init() { 
                if(!ctx) {
                    ctx = new (window.AudioContext || window.webkitAudioContext)();
                    const bSize = ctx.sampleRate * 2; noiseBuffer = ctx.createBuffer(1, bSize, ctx.sampleRate);
                    const output = noiseBuffer.getChannelData(0);
                    for (let i = 0; i < bSize; i++) output[i] = Math.random() * 2 - 1;
                } 
                if(ctx.state === 'suspended') ctx.resume();
            }

            function startMusic() {
                if (!ctx) init();
                if (musicStarted) return;
                musicStarted = true;

                const drone = ctx.createOscillator(), dGain = ctx.createGain();
                drone.type = 'sine'; drone.frequency.value = 40; dGain.gain.value = 0.1;
                drone.connect(dGain); dGain.connect(ctx.destination);
                drone.start(); bgmNodes.drone = drone; bgmNodes.dGain = dGain;

                const tension = ctx.createOscillator(), tGain = ctx.createGain(), filter = ctx.createBiquadFilter();
                tension.type = 'sawtooth'; tension.frequency.value = 60;
                filter.type = 'lowpass'; filter.frequency.value = 200;
                tGain.gain.value = 0;
                tension.connect(filter); filter.connect(tGain); tGain.connect(ctx.destination);
                tension.start(); bgmNodes.tension = tension; bgmNodes.tGain = tGain; bgmNodes.filter = filter;

                const mGain = ctx.createGain(); mGain.gain.value = 0.05; mGain.connect(ctx.destination);
                bgmNodes.mGain = mGain;

                const notesEarly = [261.63, 329.63, 392.00, 440.00], notesLate = [130.81, 155.56, 185.00, 196.00, 233.08];
                musicInterval = setInterval(() => {
                    if (gameActive && ctx) {
                        const d = playerPos.r + playerPos.c, intensity = isBoss ? 1.0 : d / 8;
                        const list = intensity > 0.5 ? notesLate : notesEarly;
                        const freq = list[Math.floor(Math.random() * list.length)];
                        const osc = ctx.createOscillator(), env = ctx.createGain();
                        osc.type = intensity > 0.7 ? 'square' : 'sine';
                        osc.frequency.setValueAtTime(freq, ctx.currentTime);
                        env.gain.setValueAtTime(0, ctx.currentTime);
                        env.gain.linearRampToValueAtTime(0.05 + (intensity * 0.05), ctx.currentTime + 0.1);
                        env.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 1.5 - (intensity * 0.5));
                        osc.connect(env); env.connect(bgmNodes.mGain);
                        osc.start(); osc.stop(ctx.currentTime + 1.5);
                    }
                }, 1800);
            }

            function stopMusic() {
                if (bgmNodes.drone) { try { bgmNodes.drone.stop(); } catch(e) {} bgmNodes.drone = null; }
                if (bgmNodes.tension) { try { bgmNodes.tension.stop(); } catch(e) {} bgmNodes.tension = null; }
                if (musicInterval) { clearInterval(musicInterval); musicInterval = null; }
                musicStarted = false;
            }

            function setIntensity(level) { 
                if (!ctx || !bgmNodes.drone || !bgmNodes.filter || !bgmNodes.tGain) return;
                const now = ctx.currentTime;
                bgmNodes.tGain.gain.linearRampToValueAtTime(level * 0.1, now + 3);
                bgmNodes.filter.frequency.linearRampToValueAtTime(100 + (level * 500), now + 3);
                bgmNodes.drone.frequency.linearRampToValueAtTime(40 - (level * 10), now + 3);
            }

            function play(freq, type, duration, vol = 0.1) {
                if(!ctx) init(); const osc = ctx.createOscillator(), gain = ctx.createGain();
                osc.type = type; osc.frequency.setValueAtTime(freq, ctx.currentTime);
                gain.gain.setValueAtTime(vol, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);
                osc.connect(gain); gain.connect(ctx.destination);
                osc.start(); osc.stop(ctx.currentTime + duration);
            }

            return { init, startMusic, stopMusic, setIntensity, play,
                ui: () => play(600, 'sine', 0.1), ping: () => play(900, 'sine', 0.4, 0.05),
                launch: () => play(150, 'sawtooth', 0.5, 0.1),
                hit: () => {
                    if(!ctx) init();
                    const thump = ctx.createOscillator(), tG = ctx.createGain(); thump.type = 'triangle';
                    thump.frequency.setValueAtTime(150, ctx.currentTime); thump.frequency.exponentialRampToValueAtTime(40, ctx.currentTime + 0.5);
                    tG.gain.setValueAtTime(0.4, ctx.currentTime); tG.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.6);
                    thump.connect(tG); tG.connect(ctx.destination); thump.start(); thump.stop(ctx.currentTime + 0.6);
                    const n = ctx.createBufferSource(), nG = ctx.createGain(); n.buffer = noiseBuffer;
                    nG.gain.setValueAtTime(0.3, ctx.currentTime); nG.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
                    n.connect(nG); nG.connect(ctx.destination); n.start(); n.stop(ctx.currentTime + 0.2);
                },
                hitAlien: () => {
                    if(!ctx) init();
                    const osc = ctx.createOscillator(), g = ctx.createGain();
                    osc.type = 'sawtooth'; osc.frequency.setValueAtTime(200, ctx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(100, ctx.currentTime + 0.4);
                    g.gain.setValueAtTime(0.3, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.4);
                    const f = ctx.createBiquadFilter(); f.type = 'bandpass'; f.Q.value = 10;
                    f.frequency.setValueAtTime(400, ctx.currentTime);
                    osc.connect(f); f.connect(g); g.connect(ctx.destination);
                    osc.start(); osc.stop(ctx.currentTime + 0.4);
                },
                miss: () => play(100, 'sine', 0.3, 0.05),
                alert: () => play(400, 'square', 0.5, 0.1),
                victory: () => { play(523.25, 'sine', 0.5); setTimeout(()=>play(659.25, 'sine', 0.5), 150); },
                defeat: () => { play(200, 'sawtooth', 1.0); }
            };
        })();

        // --- STATE ---
        let gameMode = 'campaign', playerUpgrades = [], salvagedAmmo = 0, rerollCost = 1;
        let mapData = Array(5).fill().map(() => Array(5).fill().map(() => ({ status: 'locked', hint: null })));
        let mapMissionTypes = Array(5).fill().map(() => Array(5).fill('BTL'));
        let playerPos = {r: 0, c: 0}, riftPos = {r: 4, c: 4}, riftHints = [];
        let grid = [], shots = 30, hits = 0, sonarCharges = 3, torpedoCharges = 2, busterCharges = 0;
        let currentShipTypes = [], totalShipSegments = 0, shipData = [], gameActive = false, currentMode = 'shoot';
        let pendingTorpedoOrigin = null, currentWeather = 'Clear Skies', nextWeather = 'Dense Fog', weatherCounter = 10, isGlobalFog = false;
        let selectedSub = 'Nautilus', currentMissionPos = null, isEscort = false, isBoss = false;
        let merchantPos = {r: 14, c: 14}, merchantHealth = 5, merchantMaxHealth = 5, merchantPath = [];

        // --- TURN LOGIC (CENTRALIZED) ---
        function advanceTurn() {
            if (!gameActive) return;
            weatherCounter--;
            if (weatherCounter <= 0) {
                if (isBoss) toggleBossWeather();
                else changeWeather();
            }
            if (isEscort) moveMerchant();
            checkGameOver();
            updateUI();
        }

        function signalAdvanceTurn() {
            if (!isEscort || !gameActive) return;
            Sound.ui();
            logEvent("Holding battery fire. Signaling merchant advance.", 'info');
            advanceTurn();
        }

        function changeWeather() { currentWeather = nextWeather; nextWeather = WEATHER_TYPES[Math.floor(Math.random() * (WEATHER_TYPES.length - 1))]; weatherCounter = 10; isGlobalFog = (currentWeather === 'Dense Fog'); Sound.alert(); logEvent(`Shift: ${currentWeather.toUpperCase()}.`, 'info'); renderWeatherEffects(); }
        function toggleBossWeather() { weatherCounter = 8; currentWeather = (currentWeather === 'Electrical Storm') ? 'Rough Seas' : 'Electrical Storm'; logEvent(`RIFT PHASING: ${currentWeather.toUpperCase()}.`, 'info'); Sound.alert(); renderWeatherEffects(); }

        function renderWeatherEffects() {
            document.querySelectorAll('.fog-overlay').forEach(el => el.remove());
            if (isGlobalFog) {
                for(let r=0; r<GRID_SIZE; r++) for(let c=0; c<GRID_SIZE; c++) { const cell = document.getElementById(`cell-${r}-${c}`); if(cell) { const fog = document.createElement('div'); fog.className = 'fog-overlay'; cell.appendChild(fog); } }
            }
            for(let r=0; r<GRID_SIZE; r++) for(let c=0; c<GRID_SIZE; c++) { 
                const d = grid[r][c]; 
                if (d.revealed && !d.isShip) { 
                    const el = document.getElementById(`cell-${r}-${c}`); 
                    if (el && d.neighborShips > 0) { 
                        const iO = isGlobalFog && selectedSub !== 'Ghost-6'; 
                        el.innerText = iO ? '?' : d.neighborShips; 
                        el.style.color = iO ? '#94a3b8' : getNumberColor(d.neighborShips); 
                    } 
                } 
            }
        }

        // --- CORE FUNCTIONS ---
        function initCampaign() {
            Sound.init(); Sound.startMusic();
            gameMode = 'campaign'; playerUpgrades = []; salvagedAmmo = 0; playerPos = {r: 0, c: 0}; riftHints = [];
            mapData = Array(5).fill().map(() => Array(5).fill().map(() => ({ status: 'locked', hint: null })));
            mapMissionTypes = Array(5).fill().map((_, r) => Array(5).fill().map((_, c) => (r+c > 2 && Math.random() < 0.4 ? 'ESC' : 'BTL')));
            riftPos = { r: 3 + Math.floor(Math.random()*2), c: 3 + Math.floor(Math.random()*2) };
            if (riftPos.r + riftPos.c < 6) riftPos = {r: 4, c: 4};
            mapMissionTypes[riftPos.r][riftPos.c] = 'RIFT';
            mapData[0][0].status = 'current';
            showScreen('overworld');
        }

        function initArcade() { Sound.init(); Sound.startMusic(); gameMode = 'arcade'; playerUpgrades = []; salvagedAmmo = 0; isEscort = false; isBoss = false; showBriefing(1, 1); }

        function mainMenu() { document.getElementById('overlay').classList.add('hidden'); Sound.stopMusic(); showScreen('title'); }

        function renderOverworld() {
            const container = document.getElementById('overworld-grid'); container.innerHTML = '';
            const dTotal = playerPos.r + playerPos.c; Sound.setIntensity(isBoss ? 1.0 : dTotal / 8); 
            for(let r=0; r<5; r++) for(let c=0; c<5; c++) {
                const cell = mapData[r][c];
                if (!['current', 'visited'].includes(cell.status) && isAdjacentToVisited(r, c)) if (cell.status === 'locked') cell.status = 'mission';
                const tile = document.createElement('div'), mType = mapMissionTypes[r][c];
                const currentStatus = mapData[r][c].status;
                tile.className = `map-tile rounded-lg border-2 ${getTileClass(r, c)}`;
                if (r === 0 && c === 0 && (currentStatus === 'current' || currentStatus === 'visited')) tile.innerHTML = '<span class="text-[10px] font-black text-emerald-400 uppercase">HQ</span>';
                else if (currentStatus === 'locked') tile.innerHTML = '<span class="text-xl font-bold opacity-20">?</span>';
                else if (currentStatus === 'mission') {
                    const label = mType === 'ESC' ? 'ESCORT' : (mType === 'RIFT' ? 'THE RIFT' : 'BATTLE'), colorClass = mType === 'RIFT' ? 'text-purple-400 animate-pulse' : 'text-amber-500';
                    tile.innerHTML = `<span class="text-[9px] font-bold ${colorClass}">${label}</span><span class="text-[7px] opacity-50 uppercase font-bold tracking-tighter">Dist ${r+c}</span>`;
                    tile.onclick = () => { Sound.ui(); showBriefing(r, c); };
                } else if (currentStatus === 'current') tile.innerHTML = '<span class="text-sm">‚öì</span>';
                else if (currentStatus === 'visited') {
                    tile.innerHTML = '<span class="text-[8px] text-slate-600 uppercase font-bold">Clear</span>';
                    if (cell.hint) { tile.innerHTML += '<div class="absolute top-1 right-1 text-[8px]">üëÅÔ∏è</div>'; tile.dataset.hint = cell.hint; }
                }
                container.appendChild(tile);
            }
            document.getElementById('salvaged-ammo-display').innerText = salvagedAmmo;
            document.getElementById('active-upgrades-list').innerText = playerUpgrades.length > 0 ? playerUpgrades.map(u => UPGRADES.find(ref => ref.id === u).name).join(', ') : 'None';
        }

        // --- BATTLE ACTIONS ---
        function showBriefing(r, c) {
            currentMissionPos = {r, c}; const dist = r + c;
            isEscort = (gameMode === 'campaign' && mapMissionTypes[r][c] === 'ESC');
            isBoss = (gameMode === 'campaign' && mapMissionTypes[r][c] === 'RIFT');
            document.getElementById('brief-title').innerText = isBoss ? "The Abyssal Rift" : (isEscort ? "Escort Protocol" : "Sector Neutralization");
            document.getElementById('mission-coord-display').innerText = gameMode === 'arcade' ? 'Standard Simulation' : `Sector [${r+1}-${c+1}]`;
            
            const backBtn = document.getElementById('return-map-btn');
            if (gameMode === 'arcade') {
                backBtn.innerText = "Return to Main Menu";
                backBtn.onclick = mainMenu;
            } else {
                backBtn.innerText = "Return to Map";
                backBtn.onclick = () => showScreen('overworld');
            }

            if (isBoss) { currentShipTypes = [...BOSS_FLEET]; document.getElementById('brief-objective').innerText = "Anomalous entity detected. Terminate the Elder Core."; } 
            else {
                const extra = Math.floor(dist / 3); currentShipTypes = [...BASE_FLEET]; for(let i=0; i<extra; i++) currentShipTypes.push(2);
                document.getElementById('brief-objective').innerText = isEscort ? "Protect freighter. Neutralize path hostiles." : "Locate and destroy all hostiles.";
            }
            totalShipSegments = currentShipTypes.reduce((a, b) => a + b, 0);
            const wName = isBoss ? 'ARCANE STORM' : WEATHER_TYPES[Math.floor(Math.random() * (WEATHER_TYPES.length - 1))];
            document.getElementById('brief-weather').innerHTML = `<span class="keyword font-mono">${wName}</span>`;
            document.getElementById('brief-fleet').innerText = isBoss ? "ELDER ENTITY" : `${currentShipTypes.length} Signatures Detected`;
            renderSubSelection(); showScreen('deployment');
        }

        function renderSubSelection() {
            const container = document.getElementById('sub-selection-container'); container.innerHTML = '';
            const subs = [ 
                { id: 'Nautilus', ammo: 35, sonar: 5, torp: 1, color: 'emerald', tag: 'INTEL', perk: 'Advanced scouting array. Superior starting resources.' }, 
                { id: 'The Kraken', ammo: 25, sonar: 2, torp: 5, color: 'amber', tag: 'OFFENSE', perk: 'Heavy battery focus. Expanded torpedo payload.' }, 
                { id: 'Ghost-6', ammo: 30, sonar: 3, torp: 2, color: 'indigo', tag: 'STEALTH', perk: 'E-War shielding. Immune to Storm jamming and Fog blur.' }, 
                { id: 'The Scavenger', ammo: 20, sonar: 2, torp: 2, color: 'rose', tag: 'SALVAGE', perk: 'Salvage optimizer. Double ammo/weapon recovery.' } 
            ];
            const bA = playerUpgrades.reduce((sum, id) => sum + (UPGRADES.find(u => u.id === id).bonus.shots || 0), 0);
            const bS = playerUpgrades.reduce((sum, id) => sum + (UPGRADES.find(u => u.id === id).bonus.sonar || 0), 0);
            const bT = playerUpgrades.reduce((sum, id) => sum + (UPGRADES.find(u => u.id === id).bonus.torps || 0), 0);
            subs.forEach(sub => {
                const card = document.createElement('div'); card.onclick = () => { Sound.ui(); selectedSub = sub.id; startMission(); };
                card.className = 'sub-card p-4 rounded-lg bg-slate-800/50 flex flex-col justify-between h-full font-mono';
                card.innerHTML = `
                    <div><div class="flex justify-between items-start mb-2"><h3 class="text-${sub.color}-400 font-bold uppercase text-xs">${sub.id}</h3><span class="text-[8px] bg-${sub.color}-900/50 text-${sub.color}-300 px-1 rounded uppercase font-bold tracking-widest">${sub.tag}</span></div><p class="text-[9px] text-slate-400 mb-3 italic leading-snug">${sub.perk}</p></div>
                    <div class="stat-row font-mono"><span>Ammo</span><span>${sub.ammo + bA}</span></div>
                    <div class="stat-row font-mono"><span>Sonar</span><span>${sub.sonar + bS}</span></div>
                    <div class="stat-row font-mono"><span>Torp</span><span>${sub.torp + bT}</span></div>`;
                container.appendChild(card);
            });
        }

        function startMission() {
            showScreen('game'); const sp = document.getElementById('merchant-status-panel'), ab = document.getElementById('advance-btn');
            if (isEscort) { sp.classList.remove('hidden'); ab.classList.remove('hidden'); merchantHealth = 5; merchantMaxHealth = 5; merchantPos = {r: 14, c: 14}; generateMerchantPath(); updateMerchantUI(); }
            else { sp.classList.add('hidden'); ab.classList.add('hidden'); }
            document.getElementById('battle-log').innerHTML = '';
            logEvent(`Deployment: ${selectedSub} sub. Target: ${isBoss ? 'ELDER RIFT' : 'Sector'}.`, 'info');
            const subStatMap = { 'Nautilus': [35, 5, 1], 'The Kraken': [25, 2, 5], 'Ghost-6': [30, 3, 2], 'The Scavenger': [20, 2, 2] };
            const ss = subStatMap[selectedSub];
            shots = ss[0] + playerUpgrades.reduce((sum, id) => sum + (UPGRADES.find(u => u.id === id).bonus.shots || 0), 0);
            sonarCharges = ss[1] + playerUpgrades.reduce((sum, id) => sum + (UPGRADES.find(u => u.id === id).bonus.sonar || 0), 0);
            torpedoCharges = ss[2] + playerUpgrades.reduce((sum, id) => sum + (UPGRADES.find(u => u.id === id).bonus.torps || 0), 0);
            
            // Re-initialize grid safely using loop
            grid = [];
            for (let r = 0; r < GRID_SIZE; r++) {
                grid[r] = [];
                for (let c = 0; c < GRID_SIZE; c++) {
                    grid[r][c] = { isShip: false, revealed: false, neighborShips: 0, shipId: null };
                }
            }

            shipData = currentShipTypes.map((size, index) => ({ id: index, size, health: size, isSunk: false, coords: [], isAlien: false }));
            hits = 0; busterCharges = 0; weatherCounter = 10; currentWeather = isBoss ? 'Electrical Storm' : 'Clear Skies'; nextWeather = WEATHER_TYPES[Math.floor(Math.random() * (WEATHER_TYPES.length - 1))];
            isGlobalFog = false; gameActive = true; currentMode = 'shoot';
            Sound.setIntensity(isBoss ? 1.0 : (currentMissionPos ? (currentMissionPos.r + currentMissionPos.c)/8 : 0.2));
            placeShips(); calculateNeighbors(); renderGrid(); updateUI(); if(isEscort) renderMerchant();
        }

        function handleCellClick(r, c) { 
            if (!gameActive) return; 
            const d = grid[r][c], isBossCore = isBoss && d.isShip && d.shipId === 0;
            if (isBossCore) {
                const tsAlive = shipData.slice(1).some(s => !s.isSunk);
                if (tsAlive) {
                    const el = document.getElementById(`cell-${r}-${c}`); el.classList.remove('cell-hidden'); el.classList.add('bg-slate-700', 'text-blue-400'); el.innerHTML = 'üõ°Ô∏è';
                    logEvent("Anomaly Core shielded. Sever tendrils first!", "warning"); Sound.alert(); shots--; advanceTurn(); return;
                }
            }
            if (currentMode === 'shoot') {
                if (d.revealed) return;
                if (d.isShip) { if (shipData[d.shipId].isAlien) Sound.hitAlien(); else Sound.hit(); } else Sound.miss();
                logEvent(`Battery fired at [${r+1},${c+1}]... ${d.isShip ? 'HIT!' : 'Miss.'}`, d.isShip ? 'hit' : 'miss');
                revealCell(r, c); shots--; if (shots <= 5) Sound.alert(); advanceTurn();
            } else if (currentMode === 'sonar') {
                const jammed = currentWeather === 'Electrical Storm' && selectedSub !== 'Ghost-6';
                if (d.revealed || jammed) return;
                performSonar(r, c);
            } else if (currentMode === 'torpedo' || currentMode === 'buster') {
                pendingTorpedoOrigin = {r, c}; document.getElementById('dir-selector').classList.remove('hidden');
            }
        }

        function revealCell(r, c, isFree = false) {
            if (r < 0 || r >= GRID_SIZE || c < 0 || c >= GRID_SIZE) return; 
            const d = grid[r][c]; if (d.revealed) return; 
            d.revealed = true; 
            const el = document.getElementById(`cell-${r}-${c}`); 
            if(el) el.classList.remove('cell-hidden');
            if (d.isShip) {
                if(el) { el.classList.add('cell-revealed-ship'); el.innerHTML = 'üí•'; } hits++;
                const r1 = playerUpgrades.includes('eff_1'), r2 = playerUpgrades.includes('eff_2'); if (r2) shots += 2; else if (r1) shots += 1;
                const ship = shipData[d.shipId]; ship.health--;
                if (ship.size === 3) revealRandomWater(playerUpgrades.includes('intercept_2') ? 3 : (playerUpgrades.includes('intercept_1') ? 2 : 1));
                if (ship.health <= 0) sinkShip(ship);
            } else { 
                if(el) el.classList.add('cell-revealed-water'); 
                const iO = isGlobalFog && selectedSub !== 'Ghost-6'; 
                if (d.neighborShips > 0 && el) { 
                    el.innerText = iO ? '?' : d.neighborShips; 
                    el.style.color = iO ? '#94a3b8' : getNumberColor(d.neighborShips); 
                } 
            }
        }

        function sinkShip(ship) {
            if (ship.isSunk) return; ship.isSunk = true; if (ship.isAlien) Sound.hitAlien(); else Sound.hit(); 
            const rem = ship.health; if (rem > 0) hits += rem; ship.health = 0; 
            logEvent(`Target Down: ${isBoss ? (ship.id===0 ? 'CORE' : 'TENTACLE') : (['Carrier', 'Battleship', 'Battleship', 'Radar', 'Radar', 'Corvette', 'Corvette'][ship.id] || 'Vessel')}.`, 'hit');
            const mult = selectedSub === 'The Scavenger' ? 2 : 1; if (ship.size === 2) shots += (5 * mult); if (ship.size === 5) busterCharges += (1 * mult);
            ship.coords.forEach(coord => { const el = document.getElementById(`cell-${coord.r}-${coord.c}`); if(el) { el.classList.add('cell-sunk-ship'); el.innerHTML = ship.isAlien ? 'üêô' : 'üö¢'; el.classList.remove('cell-hidden'); } grid[coord.r][coord.c].revealed = true; });
            ship.coords.forEach(coord => { for (let dr = -1; dr <= 1; dr++) for (let dc = -1; dc <= 1; dc++) { const nr = coord.r + dr, nc = coord.c + dc; if (nr >= 0 && nr < GRID_SIZE && nc >= 0 && nc < GRID_SIZE) if (!grid[nr][nc].isShip) revealCell(nr, nc, true); } });
            checkGameOver(); updateUI();
        }

        function performSonar(r, c) {
            if (sonarCharges <= 0) return;
            sonarCharges--; Sound.ping(); handleCellHover(r, c, false); cancelWeapon();
            const rm = -1, rM = playerUpgrades.includes('drone_1') ? 2 : 1;
            for (let dr = rm; dr <= rM; dr++) for (let dc = rm; dc <= rM; dc++) {
                const nr = r + dr, nc = c + dc;
                if (nr >= 0 && nr < GRID_SIZE && nc >= 0 && nc < GRID_SIZE) {
                    const el = document.getElementById(`cell-${nr}-${nc}`), d = grid[nr][nc]; if(el) el.classList.add('cell-sonar');
                    if (playerUpgrades.includes('drone_2') && d.isShip && !d.revealed) { if (shipData[d.shipId].isAlien) Sound.hitAlien(); else Sound.hit(); revealCell(nr, nc, true); }
                    setTimeout(() => { if(el) { el.classList.remove('cell-sonar'); if (d.isShip && (!playerUpgrades.includes('drone_2') || !d.revealed)) el.innerHTML = '<span class="text-sm scale-110" style="color: #fbbf24;">üö¢</span>'; else if (!d.revealed) el.innerHTML = '<span class="text-[10px] opacity-20">üåä</span>'; } }, 1200);
                }
            }
            advanceTurn();
        }

        function fireTorpedoActual(dir) {
            const isB = (currentMode === 'buster'); if (isB ? busterCharges <= 0 : torpedoCharges <= 0) return; isB ? busterCharges-- : torpedoCharges--; Sound.launch();
            shots -= (playerUpgrades.includes('buster_2') ? 0 : (playerUpgrades.includes('buster_1') ? 1 : 2)); cancelWeapon();
            const {r, c} = pendingTorpedoOrigin; let currR = r, currC = c, hit = false, path = [], steps = 0, maxRange = (currentWeather === 'Rough Seas') ? 5 : 99;
            while (currR >= 0 && currR < GRID_SIZE && currC >= 0 && currC < GRID_SIZE && !hit && steps < maxRange) {
                path.push({r: currR, c: currC}); if (grid[currR][currC].isShip) hit = true;
                if (dir === 'up') currR--; else if (dir === 'down') currR++; else if (dir === 'left') currC--; else if (dir === 'right') currC++; steps++;
            }
            path.forEach((pos, idx) => { setTimeout(() => { const el = document.getElementById(`cell-${pos.r}-${pos.c}`); if(el) el.classList.add(isB ? 'cell-buster-path' : 'cell-torpedo-path'); setTimeout(() => { if(el) { el.classList.remove('cell-buster-path', 'cell-torpedo-path'); if (idx === path.length - 1 && hit) { const ts = shipData[grid[pos.r][pos.c].shipId]; if (ts.isAlien) Sound.hitAlien(); else Sound.hit(); if (isB) sinkShip(ts); else for (let dr = -1; dr <= 1; dr++) for (let dc = -1; dc <= 1; dc++) revealCell(pos.r + dr, pos.c + dc, true); } else revealCell(pos.r, pos.c, true); if (idx === path.length - 1) advanceTurn(); } }, 150); }, idx * 80); });
        }

        function placeShips() {
            const dist = currentMissionPos ? (currentMissionPos.r + currentMissionPos.c) : 0;
            shipData.forEach((ship, idx) => {
                let placed = false, attempts = 0;
                while (!placed && attempts < 1500) {
                    const r = Math.floor(Math.random() * GRID_SIZE), c = Math.floor(Math.random() * GRID_SIZE);
                    let shape = [];
                    if (isBoss && idx === 0) shape = BOSS_CORE_SHAPE;
                    else if (isBoss || (dist >= 4) || (dist === 3 && Math.random() < 0.5)) {
                        const v = ALIEN_SHAPES[ship.size] || ALIEN_SHAPES[2]; shape = v[Math.floor(Math.random() * v.length)];
                    } else { const h = Math.random() < 0.5; shape = Array.from({length: ship.size}, (_, i) => h ? [0, i] : [i, 0]); }
                    if (canPlaceShape(r, c, shape)) {
                        const actualCoords = [];
                        shape.forEach(offset => { 
                            const nr = r + offset[0], nc = c + offset[1]; 
                            if (grid[nr] && grid[nr][nc]) {
                                grid[nr][nc].isShip = true; 
                                grid[nr][nc].shipId = ship.id; 
                                ship.coords.push({r: nr, c: nc}); 
                                actualCoords.push({r: nr, c: nc}); 
                            }
                        });
                        ship.isAlien = !isLinear(actualCoords); placed = true;
                    } attempts++;
                }
            });
        }

        function canPlaceShape(r, c, shape) {
            for (let offset of shape) {
                const nr = r + offset[0], nc = c + offset[1];
                if (nr < 0 || nr >= GRID_SIZE || nc < 0 || nc >= GRID_SIZE) return false;
                for (let dr = -1; dr <= 1; dr++) for (let dc = -1; dc <= 1; dc++) { const nr2 = nr + dr, nc2 = nc + dc; if (nr2 >= 0 && nr2 < GRID_SIZE && nc2 >= 0 && nc2 < GRID_SIZE) if (grid[nr2][nc2].isShip) return false; }
                if (isEscort && nr === 14 && nc === 14) return false;
            } return true;
        }

        function calculateNeighbors() {
            for (let r = 0; r < GRID_SIZE; r++) for (let c = 0; c < GRID_SIZE; c++) {
                if (grid[r][c].isShip) continue;
                let count = 0; for (let dr = -1; dr <= 1; dr++) for (let dc = -1; dc <= 1; dc++) { const nr = r + dr, nc = c + dc; if (nr >= 0 && nr < GRID_SIZE && nc >= 0 && nc < GRID_SIZE) if (grid[nr][nc].isShip) count++; }
                grid[r][c].neighborShips = count;
            }
        }

        function renderGrid() {
            const container = document.getElementById('game-grid'); container.style.gridTemplateColumns = `repeat(${GRID_SIZE}, 1fr)`; container.innerHTML = '';
            for (let r = 0; r < GRID_SIZE; r++) for (let c = 0; c < GRID_SIZE; c++) {
                const cell = document.createElement('div'); cell.className = 'grid-cell border border-slate-800/40 flex items-center justify-center font-bold cell-hidden'; cell.id = `cell-${r}-${c}`; cell.onclick = () => handleCellClick(r, c); cell.onmouseenter = () => handleCellHover(r, c, true); cell.onmouseleave = () => handleCellHover(r, c, false); container.appendChild(cell);
            }
        }

        function updateUI() { const se = document.getElementById('shots-count'); se.innerText = shots; document.getElementById('sonar-count').innerText = sonarCharges; document.getElementById('torpedo-count').innerText = torpedoCharges; document.getElementById('buster-count').innerText = busterCharges; document.getElementById('weather-text').innerHTML = `<span class="keyword">${currentWeather}</span>`; document.getElementById('next-weather').innerText = isBoss ? 'UNSTABLE PHASING' : `Forecast: ${nextWeather} in ${weatherCounter}`; document.getElementById('sonar-btn').disabled = (currentWeather === 'Electrical Storm' && selectedSub !== 'Ghost-6') || sonarCharges <= 0; document.getElementById('buster-btn').disabled = busterCharges <= 0; document.getElementById('fleet-count').innerText = `${hits}/${totalShipSegments}`; const dash = document.getElementById('fleet-dashboard'); dash.innerHTML = ''; shipData.forEach(ship => { const cont = document.createElement('div'); cont.className = `ship-indicator ${ship.isSunk ? 'ship-sunk' : ''}`; if (ship.size === 5) cont.style.borderColor = '#ef444455'; for (let i = 0; i < ship.size; i++) { const seg = document.createElement('div'); seg.className = 'ship-segment'; if (!ship.isSunk && i < (ship.size - ship.health)) seg.style.background = '#94a3b8'; cont.appendChild(seg); } dash.appendChild(cont); }); if (shots <= 5) { se.parentElement.classList.add('text-red-600', 'animate-pulse'); } else { se.parentElement.classList.remove('text-red-600', 'animate-pulse'); } }

        function moveMerchant() { if (!isEscort || !gameActive) return; const idx = merchantPath.findIndex(p => p.r === merchantPos.r && p.c === merchantPos.c); if (idx < merchantPath.length - 1) { merchantPos = merchantPath[idx + 1]; renderMerchant(); checkEngagements(); } }
        function checkEngagements() { for (let dr = -1; dr <= 1; dr++) for (let dc = -1; dc <= 1; dc++) { const nr = merchantPos.r + dr, nc = merchantPos.c + dc; if (nr >= 0 && nr < GRID_SIZE && nc >= 0 && nc < GRID_SIZE) { const cellData = grid[nr][nc]; if (cellData.isShip && !shipData[cellData.shipId].isSunk) { merchantHealth--; Sound.alert(); logEvent(`WARNING: Merchant damaged at [${nr+1}, ${nc+1}]!`, 'warning'); break; } } } updateMerchantUI(); if (merchantHealth <= 0) endGame(false); else if (merchantPos.r === 0 && merchantPos.c === 0) endGame(true); }
        function renderMerchant() { const old = document.querySelector('.cell-merchant'); if (old) { old.classList.remove('cell-merchant'); const parts = old.id.split('-'), pr = parseInt(parts[1]), pc = parseInt(parts[2]); old.innerHTML = grid[pr][pc].revealed ? (grid[pr][pc].isShip ? 'üí•' : grid[pr][pc].neighborShips || '') : ''; } const cell = document.getElementById(`cell-${merchantPos.r}-${merchantPos.c}`); if (cell) { cell.classList.add('cell-merchant'); cell.innerHTML = '<span class="text-xl">üö¢</span>'; } }
        function updateMerchantUI() { const bar = document.getElementById('merchant-health-bar'), txt = document.getElementById('merchant-health-text'), pct = (merchantHealth / merchantMaxHealth) * 100; bar.style.width = `${pct}%`; bar.style.backgroundColor = pct < 30 ? '#ef4444' : (pct < 60 ? '#f59e0b' : '#10b981'); txt.innerText = `${merchantHealth}/${merchantMaxHealth}`; }
        function generateMerchantPath() { merchantPath = []; let r = 14, c = 14; merchantPath.push({r, c}); while (r > 0 || c > 0) { if (r > 0 && c > 0) { if (Math.random() < 0.5) r--; else c--; } else if (r > 0) r--; else c--; merchantPath.push({r, c}); } }

        function checkGameOver() { if (isBoss && shipData[0].isSunk) endGame(true); else if (hits >= totalShipSegments) endGame(true); else if (shots <= 0 && gameActive) endGame(false); else if (isEscort && (merchantHealth <= 0 || (merchantPos.r === 0 && merchantPos.c === 0))) { if(merchantHealth <= 0) endGame(false); else endGame(true); } }
        
        function endGame(win) {
            gameActive = false; win ? Sound.victory() : Sound.defeat();
            for(let r=0; r<GRID_SIZE; r++) for(let c=0; c<GRID_SIZE; c++) { const el = document.getElementById(`cell-${r}-${c}`), d = grid[r][c]; if (el && !d.revealed && d.isShip) { el.classList.remove('cell-hidden'); el.classList.add('bg-slate-700/50'); el.innerHTML = shipData[d.shipId].isAlien ? 'üêô' : 'üö¢'; } }
            setTimeout(() => {
                const overlay = document.getElementById('overlay'), title = document.getElementById('overlay-title'), msg = document.getElementById('overlay-msg'), b1 = document.getElementById('end-action-btn'), b2 = document.getElementById('secondary-action-btn');
                overlay.classList.remove('hidden'); b2.classList.add('hidden');
                if (win) {
                    title.innerText = isBoss ? "ANOMALY SEALED" : "VICTORY"; title.className = "text-6xl font-black mb-4 text-emerald-500 tracking-tighter uppercase italic font-mono";
                    if (isBoss) { msg.innerText = "The Abyssal Rift is closed. Expedition successful."; b1.innerText = "Main Menu"; b1.onclick = mainMenu; }
                    else if (gameMode === 'campaign') { msg.innerText = `Sector secured. ${shots} ammo salvaged. Arcane echo recovered.`; b1.innerText = "Claim Rewards"; b1.onclick = () => { salvagedAmmo += shots; mapData[currentMissionPos.r][currentMissionPos.c].hint = generateRiftHint(); showScreen('reward'); overlay.classList.add('hidden'); }; }
                    else { msg.innerText = `Sector clear. Assignment ended.`; b1.innerText = "Main Menu"; b1.onclick = mainMenu; }
                } else {
                    title.innerText = "DEFEAT"; title.className = "text-6xl font-black mb-4 text-red-600 tracking-tighter uppercase italic font-mono";
                    if (gameMode === 'campaign') {
                        msg.innerText = isEscort && merchantHealth <= 0 ? "Vessel lost. search area compromised." : "Ordinance failure. Hostiles escaped.";
                        b1.innerText = "Retry Sector";
                        b1.onclick = () => { overlay.classList.add('hidden'); startMission(); };
                        b2.classList.remove('hidden');
                        b2.innerText = "Abandon Campaign";
                        b2.onclick = mainMenu;
                    } else {
                        msg.innerText = "Simulation ended.";
                        b1.innerText = "Main Menu";
                        b1.onclick = mainMenu;
                    }
                }
            }, 1500);
        }

        function handleCellHover(r, c, enter) { if (currentMode !== 'sonar' || !gameActive) return; const rm = -1, rM = playerUpgrades.includes('drone_1') ? 2 : 1; for (let dr = rm; dr <= rM; dr++) for (let dc = rm; dc <= rM; dc++) { const nr = r + dr, nc = c + dc; if (nr >= 0 && nr < GRID_SIZE && nc >= 0 && nc < GRID_SIZE) { const el = document.getElementById(`cell-${nr}-${nc}`); if (el) enter ? el.classList.add('cell-sonar-preview') : el.classList.remove('cell-sonar-preview'); } } }
        function applyUpgrade(id) { playerUpgrades.push(id); mapData[currentMissionPos.r][currentMissionPos.c].status = 'visited'; for(let r=0; r<5; r++) for(let c=0; c<5; c++) if(mapData[r][c].status === 'current') mapData[r][c].status = 'visited'; playerPos = {r: currentMissionPos.r, c: currentMissionPos.c}; mapData[playerPos.r][playerPos.c].status = 'current'; showScreen('overworld'); }
        function cancelWeapon() { currentMode = 'shoot'; ['sonar-btn', 'torpedo-btn', 'buster-btn'].forEach(id => document.getElementById(id).classList.remove('weapon-active')); document.getElementById('dir-selector').classList.add('hidden'); document.getElementById('status-text').innerText = "READY"; updateUI(); }
        function rerollRewards() { if (salvagedAmmo >= rerollCost) { Sound.init(); salvagedAmmo -= rerollCost; rerollCost *= 2; Sound.ui(); document.getElementById('salvaged-ammo-display').innerText = salvagedAmmo; document.getElementById('reroll-cost').innerText = rerollCost; refreshRewardDisplay(); } }
        function generateRewards() { rerollCost = 1; document.getElementById('reroll-cost').innerText = rerollCost; refreshRewardDisplay(); }
        function refreshRewardDisplay() { const container = document.getElementById('reward-options-container'); container.innerHTML = ''; const available = UPGRADES.filter(u => !playerUpgrades.includes(u.id) && (!u.req || playerUpgrades.includes(u.req))); const options = [...available].sort(() => 0.5 - Math.random()).slice(0, 3); options.forEach(opt => { const card = document.createElement('div'); card.onclick = () => { Sound.ui(); applyUpgrade(opt.id); }; card.className = `reward-card bg-slate-900 p-6 rounded-xl text-center border-2 border-slate-700 font-mono`; card.innerHTML = `<h3 class="text-amber-400 font-bold uppercase text-sm mb-2">${opt.name}</h3><p class="text-xs text-slate-400 leading-tight">${opt.desc}</p><div class="mt-4 text-[10px] text-emerald-500 font-bold uppercase tracking-widest">Claim</div>`; container.appendChild(card); }); document.getElementById('reroll-btn').disabled = salvagedAmmo < rerollCost; }
        function abortMatch() { Sound.init(); if (gameMode === 'arcade') mainMenu(); else showScreen('overworld'); }
        function revealRandomWater(count) { let revealed = 0, attempts = 0; while (revealed < count && attempts < 100) { const r = Math.floor(Math.random() * GRID_SIZE), c = Math.floor(Math.random() * GRID_SIZE); if (!grid[r][c].isShip && !grid[r][c].revealed) { revealCell(r, c, true); revealed++; } attempts++; } }

        // --- TOGGLES ---
        function activateSonar() { Sound.init(); const j = currentWeather === 'Electrical Storm' && selectedSub !== 'Ghost-6'; if (currentMode === 'sonar') cancelWeapon(); else if (sonarCharges > 0 && !j) { cancelWeapon(); currentMode = 'sonar'; document.getElementById('sonar-btn').classList.add('weapon-active'); document.getElementById('status-text').innerText = "SONAR ACTIVE"; } }
        function activateTorpedo() { Sound.init(); if (currentMode === 'torpedo') cancelWeapon(); else if (torpedoCharges > 0) { cancelWeapon(); currentMode = 'torpedo'; document.getElementById('torpedo-btn').classList.add('weapon-active'); document.getElementById('status-text').innerText = "TORPEDO ACTIVE"; } }
        function activateBuster() { Sound.init(); if (currentMode === 'buster') cancelWeapon(); else if (busterCharges > 0) { cancelWeapon(); currentMode = 'buster'; document.getElementById('buster-btn').classList.add('weapon-active'); document.getElementById('status-text').innerText = "BUSTER READY"; } }

        // --- LISTENERS ---
        window.onload = function() { initTooltips(); showScreen('title'); 
            document.getElementById('btn-up').onclick = () => fireTorpedoActual('up');
            document.getElementById('btn-down').onclick = () => fireTorpedoActual('down');
            document.getElementById('btn-left').onclick = () => fireTorpedoActual('left');
            document.getElementById('btn-right').onclick = () => fireTorpedoActual('right');
        };
    </script>
</body>
</html>
