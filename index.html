<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abyssal Recon: Tactical Command</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap');
        
        body {
            background-color: #0f172a;
            color: #e2e8f0;
            font-family: 'Space Mono', monospace;
            user-select: none;
            overflow-x: hidden;
        }

        #game-grid, #overworld-grid {
            display: grid;
        }

        .grid-cell {
            aspect-ratio: 1 / 1;
            transition: all 0.15s ease;
            font-size: 0.75rem;
            position: relative;
        }

        .cell-hidden {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
        }

        .cell-hidden:hover {
            background: #334155;
            cursor: crosshair;
        }

        .cell-revealed-water {
            background: #0c4a6e;
            color: #7dd3fc;
        }

        .cell-revealed-ship {
            background: #991b1b;
            animation: hit-shake 0.3s ease-in-out;
            z-index: 10;
        }

        .cell-sunk-ship {
            background: #450a0a !important;
            color: #ef4444 !important;
            filter: grayscale(0.2);
        }

        @keyframes hit-shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }

        .cell-sonar {
            background: #065f46 !important;
            box-shadow: inset 0 0 10px #10b981;
            z-index: 20;
        }

        .cell-torpedo-path {
            background: #f59e0b !important;
            box-shadow: 0 0 10px #f59e0b;
            z-index: 20;
        }

        .cell-buster-path {
            background: #ef4444 !important;
            box-shadow: 0 0 20px #ef4444;
            z-index: 20;
        }

        .fog-overlay {
            position: absolute;
            inset: 0;
            background: rgba(148, 163, 184, 0.3);
            backdrop-filter: blur(4px);
            pointer-events: none;
            z-index: 5;
            animation: fog-pulse 6s ease-in-out infinite;
        }

        @keyframes fog-pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 0.8; }
        }

        .radar-sweep {
            position: absolute;
            width: 100%;
            height: 2px;
            background: rgba(16, 185, 129, 0.1);
            top: 0;
            animation: sweep 6s linear infinite;
            pointer-events: none;
            z-index: 30;
        }

        @keyframes sweep {
            from { top: 0; }
            to { top: 100%; }
        }

        .weapon-active {
            border-color: white !important;
            box-shadow: 0 0 15px rgba(255,255,255,0.4);
            transform: translateY(-2px);
        }

        .ship-indicator {
            display: flex;
            gap: 2px;
            padding: 4px;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 4px;
            border: 1px solid transparent;
        }
        
        .ship-segment {
            width: 8px;
            height: 12px;
            background: #475569;
            border-radius: 1px;
        }

        .ship-sunk .ship-segment {
            background: #ef4444;
            opacity: 0.3;
        }
        
        .ship-sunk {
            position: relative;
            border-color: #ef444433 !important;
        }

        .ship-sunk::after {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            width: 100%;
            height: 2px;
            background: #ef4444;
            transform: rotate(-5deg);
        }

        .weather-card {
            background: linear-gradient(to bottom, #1e293b, #0f172a);
            border-left: 4px solid #3b82f6;
        }

        .btn-abort {
            transition: all 0.2s;
            background: #450a0a;
            border: 1px solid #991b1b;
        }
        .btn-abort:hover {
            background: #991b1b;
            color: white;
        }

        .sub-card, .reward-card {
            transition: all 0.3s;
            cursor: pointer;
            border: 1px solid #334155;
        }
        .sub-card:hover, .reward-card:hover {
            background: #1e293b;
            border-color: #10b981;
            transform: translateY(-5px);
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            padding: 2px 0;
        }

        .map-tile {
            aspect-ratio: 1 / 1;
            border: 1px solid #334155;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        .tile-hq {
            background: #064e3b;
            border-color: #10b981;
        }
        .tile-mission {
            background: #1e293b;
            cursor: pointer;
        }
        .tile-mission:hover {
            background: #334155;
            border-color: #fbbf24;
        }
        .tile-locked {
            background: #0f172a;
            opacity: 0.5;
            color: #475569;
        }
        .tile-current {
            box-shadow: inset 0 0 15px #10b981;
            border-color: #10b981;
            z-index: 10;
        }
        .tile-visited {
            background: #0f172a;
            border-color: #1e293b;
            opacity: 0.8;
        }

        .glitch-text {
            text-shadow: 2px 2px #ef4444, -2px -2px #3b82f6;
        }

        /* Battle Log Styles */
        #battle-log::-webkit-scrollbar {
            width: 4px;
        }
        #battle-log::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 2px;
        }
        .log-entry {
            border-left: 2px solid transparent;
            animation: slide-in 0.2s ease-out;
        }
        @keyframes slide-in {
            from { opacity: 0; transform: translateX(10px); }
            to { opacity: 1; transform: translateX(0); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <!-- Screen 0: Title Screen -->
    <div id="title-screen" class="min-h-screen w-full flex flex-col items-center justify-center">
        <div class="text-center mb-16 relative">
            <div class="absolute -inset-10 bg-emerald-500/10 blur-3xl rounded-full"></div>
            <h1 class="text-7xl font-black text-emerald-500 uppercase tracking-tighter italic glitch-text mb-2">Abyssal Recon</h1>
            <p class="text-slate-400 font-bold tracking-[0.5em] text-sm uppercase">Deduction-Based Naval Warfare</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full max-w-2xl">
            <button onclick="initCampaign()" class="group relative bg-slate-900 border border-emerald-500/50 p-8 rounded-xl text-left transition-all hover:bg-slate-800 hover:scale-105 shadow-xl">
                <div class="absolute top-4 right-4 text-[10px] bg-emerald-900 text-emerald-400 px-2 py-1 rounded font-bold uppercase tracking-widest">Recommended</div>
                <h2 class="text-2xl font-black text-emerald-400 uppercase mb-2">Campaign</h2>
                <p class="text-xs text-slate-400 leading-relaxed">Navigate the theater map, claim permanent upgrades, and clear sectors. Persistent progression across multiple missions.</p>
                <div class="mt-6 flex items-center gap-2 text-emerald-500 font-bold text-[10px] uppercase tracking-widest group-hover:gap-4 transition-all">
                    Initialize Operations <span>â†’</span>
                </div>
            </button>

            <button onclick="initArcade()" class="group relative bg-slate-900 border border-slate-700 p-8 rounded-xl text-left transition-all hover:bg-slate-800 hover:border-blue-500/50 hover:scale-105 shadow-xl">
                <h2 class="text-2xl font-black text-blue-400 uppercase mb-2">Arcade</h2>
                <p class="text-xs text-slate-400 leading-relaxed">Single deployment scenario. Standard fleet and equipment. Test your skills in a one-off sector clear.</p>
                <div class="mt-6 flex items-center gap-2 text-blue-500 font-bold text-[10px] uppercase tracking-widest group-hover:gap-4 transition-all">
                    Quick Deployment <span>â†’</span>
                </div>
            </button>
        </div>

        <div class="mt-16 text-[10px] text-slate-600 uppercase tracking-widest font-bold border-t border-slate-800 pt-4">
            Command Center v4.4 // Terminal Connected
        </div>
    </div>

    <!-- Screen 1: Overworld Map -->
    <div id="overworld-screen" class="hidden max-w-2xl w-full flex flex-col items-center py-10">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-black text-emerald-500 uppercase tracking-tighter italic">Theater of Operations</h1>
            <p class="text-slate-500 font-bold tracking-widest text-xs mt-2 uppercase">Campaign Progress</p>
        </div>

        <div id="overworld-grid" class="grid grid-cols-5 gap-2 w-full bg-slate-900 p-4 rounded-xl border border-slate-800 shadow-2xl"></div>

        <div class="mt-8 flex gap-4 w-full">
            <div class="bg-slate-800/50 p-4 rounded border border-slate-700 flex-1">
                <p class="text-[10px] text-slate-400 uppercase font-bold mb-1">Fleet Upgrades</p>
                <div id="active-upgrades-list" class="text-[9px] text-emerald-400 font-bold space-y-1">None</div>
            </div>
            <div class="bg-slate-800/50 p-4 rounded border border-slate-700 flex-1 text-right">
                <p class="text-[10px] text-slate-400 uppercase font-bold mb-1">Salvaged Ammo</p>
                <div id="salvaged-ammo-display" class="text-xl font-bold text-amber-500">0</div>
                <p class="text-[8px] text-slate-500 uppercase">Available for Rerolls</p>
            </div>
        </div>
        <button onclick="mainMenu()" class="mt-10 text-[9px] text-slate-500 hover:text-red-400 transition-colors uppercase font-bold tracking-widest">Quit to Main Menu</button>
    </div>

    <!-- Screen 2: Reward Choice -->
    <div id="reward-screen" class="hidden max-w-4xl w-full flex flex-col items-center py-10">
        <div class="text-center mb-10">
            <h1 class="text-4xl font-black text-amber-500 uppercase tracking-tighter italic">Sector Cleared</h1>
            <p class="text-slate-500 font-bold tracking-widest text-xs mt-2 uppercase">Tactical Salvage Identified</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 w-full mb-8" id="reward-options-container"></div>
        <div class="flex flex-col items-center gap-4">
            <button id="reroll-btn" onclick="rerollRewards()" class="bg-slate-800 hover:bg-slate-700 border border-amber-500/50 px-8 py-3 rounded-full font-bold text-xs uppercase tracking-widest transition-all">
                Reroll Options (Cost: <span id="reroll-cost">1</span> Ammo)
            </button>
        </div>
    </div>

    <!-- Screen 3: Deployment Phase -->
    <div id="deployment-screen" class="hidden max-w-4xl w-full flex flex-col items-center py-10">
        <div class="text-center mb-10">
            <h1 class="text-4xl font-black text-emerald-500 uppercase tracking-tighter italic">Mission Briefing</h1>
            <p id="mission-coord-display" class="text-slate-500 font-bold tracking-widest text-xs mt-2 uppercase">Sector [0,0]</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 w-full">
            <div class="md:col-span-1 bg-slate-900 border border-slate-700 p-6 rounded-lg self-start">
                <h2 class="text-emerald-400 font-bold uppercase text-sm mb-4 border-b border-slate-700 pb-2">Intelligence</h2>
                <div class="space-y-4">
                    <div><p class="text-[10px] text-slate-500 uppercase">Sector Weather</p><p id="brief-weather" class="text-sm font-bold text-blue-400 uppercase">Heavy Fog Patterns</p></div>
                    <div><p class="text-[10px] text-slate-500 uppercase">Fleet Signatures</p><p id="brief-fleet" class="text-sm font-bold text-red-400 uppercase tracking-tighter">7 Confirmed</p></div>
                    <div><p class="text-[10px] text-slate-500 uppercase">Threat Level</p><p id="brief-threat" class="text-sm font-bold text-orange-400 uppercase">Standard</p></div>
                </div>
                <button id="return-map-btn" onclick="showScreen('overworld')" class="mt-6 w-full py-2 border border-slate-700 rounded text-[10px] uppercase font-bold hover:bg-slate-800">Return to Map</button>
            </div>
            <div class="md:col-span-2 space-y-4">
                <h2 class="text-slate-300 font-bold uppercase text-sm mb-2 text-center md:text-left">Select your submarine</h2>
                <div id="sub-selection-container" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
            </div>
        </div>
    </div>

    <!-- Screen 4: Tactical Interface -->
    <div id="game-screen" class="hidden max-w-6xl w-full py-6">
        <!-- Stats Header -->
        <div class="mb-4 max-w-3xl mx-auto">
            <div class="flex justify-between items-end border-b border-slate-700 pb-2">
                <div>
                    <h1 id="sub-name-display" class="text-2xl font-bold text-emerald-500 uppercase tracking-tighter">Nautilus</h1>
                    <p id="mode-tag-display" class="text-[10px] text-slate-400 font-bold tracking-widest">TACTICAL INTERFACE // DEPLOYED</p>
                </div>
                <div class="text-right">
                    <div class="text-xl font-bold flex items-center justify-end gap-2">
                        <span id="shots-count">30</span> 
                        <svg class="w-5 h-5 text-orange-500" fill="currentColor" viewBox="0 0 24 24"><path d="M12,2L4.5,20.29L5.21,21L12,18L18.79,21L19.5,20.29L12,2Z"/></svg>
                    </div>
                    <div class="text-[10px] uppercase text-slate-500 tracking-widest">Ammunition</div>
                </div>
            </div>
            <div id="fleet-dashboard" class="flex flex-wrap gap-3 mt-3 bg-slate-900/50 p-3 rounded border border-slate-800"></div>
            <div class="grid grid-cols-6 gap-2 mt-3">
                <div class="weather-card p-2 rounded border border-slate-700 flex flex-col justify-center col-span-2">
                    <div class="text-[10px] text-slate-400 uppercase font-bold tracking-tighter">Weather Systems</div>
                    <div id="weather-text" class="text-xs font-bold text-blue-400 uppercase">Clear Skies</div>
                    <div id="next-weather" class="text-[9px] font-bold text-slate-500 uppercase mt-1 tracking-tight">Forecast: Loading...</div>
                </div>
                <button id="sonar-btn" class="bg-emerald-900/50 hover:bg-emerald-800 p-2 rounded border border-emerald-700 transition-all disabled:opacity-30 col-span-1">
                    <div class="text-[10px] text-emerald-300 uppercase">Sonar</div>
                    <div id="sonar-count" class="text-lg font-bold text-emerald-400">3</div>
                </button>
                <button id="torpedo-btn" class="bg-amber-900/50 hover:bg-amber-800 p-2 rounded border border-amber-700 transition-all col-span-1">
                    <div class="text-[10px] text-amber-300 uppercase">Torp</div>
                    <div id="torpedo-count" class="text-lg font-bold text-amber-400">2</div>
                </button>
                <button id="buster-btn" class="bg-red-900/30 hover:bg-red-900/50 p-2 rounded border border-red-900 transition-all col-span-1 disabled:opacity-20">
                    <div class="text-[10px] text-red-400 uppercase">Buster</div>
                    <div id="buster-count" class="text-lg font-bold text-red-500">0</div>
                </button>
                <div class="bg-slate-800 p-2 rounded border border-slate-700 flex flex-col justify-between col-span-1">
                    <div>
                        <div class="text-[10px] text-slate-400 uppercase">Hull Hits</div>
                        <div id="fleet-count" class="text-xs font-bold text-red-400 tracking-tighter">0/0</div>
                    </div>
                    <div>
                        <div id="status-text" class="text-[9px] font-bold text-emerald-500 uppercase">Ready</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Interaction Area (Grid + Log) -->
        <div class="flex flex-col lg:flex-row items-start justify-center gap-6">
            
            <!-- Game Board -->
            <div class="relative p-1 bg-slate-800 rounded shadow-2xl border border-slate-700 overflow-hidden">
                <div class="radar-sweep"></div>
                <div id="game-grid" class="gap-px bg-slate-900 border border-slate-900" style="width: min(95vw, 600px);"></div>
                <div id="dir-selector" class="hidden absolute inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm">
                    <div class="bg-slate-800 p-4 rounded-lg border border-amber-500 shadow-2xl text-center">
                        <p id="target-vector-text" class="text-amber-500 font-bold mb-4 uppercase text-sm">Target Vector</p>
                        <div class="grid grid-cols-3 gap-2">
                            <div></div><button onclick="fireTorpedoActual('up')" class="p-3 bg-slate-700 hover:bg-amber-600 rounded">â–²</button><div></div>
                            <button onclick="fireTorpedoActual('left')" class="p-3 bg-slate-700 hover:bg-amber-600 rounded">â—€</button>
                            <button onclick="cancelWeapon()" class="p-3 bg-red-900/50 hover:bg-red-600 rounded text-xs">X</button>
                            <button onclick="fireTorpedoActual('right')" class="p-3 bg-slate-700 hover:bg-amber-600 rounded">â–¶</button>
                            <div></div><button onclick="fireTorpedoActual('down')" class="p-3 bg-slate-700 hover:bg-amber-600 rounded">â–¼</button><div></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Battle Log Sidebar -->
            <div class="w-full lg:w-80 h-[300px] lg:h-[608px] bg-slate-900/80 border border-slate-700 rounded-lg flex flex-col shadow-2xl">
                <div class="p-3 border-b border-slate-700 bg-slate-800/50 flex justify-between items-center">
                    <h2 class="text-[10px] font-black text-slate-400 uppercase tracking-widest flex items-center gap-2">
                        <span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>
                        Battle Telemetry
                    </h2>
                    <span class="text-[8px] text-slate-600 font-bold uppercase">Active Stream</span>
                </div>
                <div id="battle-log" class="flex-1 overflow-y-auto p-4 space-y-3">
                    <!-- Log entries generated here -->
                    <div class="text-[9px] text-slate-600 italic">Establishing data link...</div>
                </div>
                <div class="p-2 border-t border-slate-700/50 bg-slate-950/30 text-[8px] text-slate-500 text-center uppercase font-bold tracking-tighter">
                    Encrypted Tactical Feed // End of Line
                </div>
            </div>
        </div>

        <div class="mt-8 flex flex-col items-center gap-4">
            <button onclick="abortMatch()" class="btn-abort text-[10px] px-8 py-2 rounded font-bold text-red-400 uppercase tracking-widest border border-red-900/30">
                Abort Mission
            </button>
        </div>
    </div>

    <div id="overlay" class="hidden fixed inset-0 bg-slate-900/95 flex flex-col items-center justify-center z-[100] p-6 text-center">
        <h2 id="overlay-title" class="text-6xl font-black mb-4 tracking-tighter">DEFEAT</h2>
        <p id="overlay-msg" class="text-xl text-slate-400 mb-8 max-w-md"></p>
        <button id="end-action-btn" onclick="mainMenu()" class="bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-4 px-12 rounded-full transition-all transform hover:scale-105 shadow-lg shadow-emerald-900/20 uppercase tracking-widest">
            Main Menu
        </button>
    </div>

    <script>
        // --- Game Config ---
        const GRID_SIZE = 15;
        const BASE_FLEET = [5, 4, 4, 3, 3, 2, 2];
        const WEATHER_TYPES = ['Clear Skies', 'Dense Fog', 'Electrical Storm'];
        
        const UPGRADES = [
            { id: 'ammo_1', name: 'Ammo +5', desc: 'Starting ammo +5', bonus: { shots: 5 }, req: null },
            { id: 'ammo_2', name: 'Ammo II +10', desc: 'Starting ammo +10', bonus: { shots: 10 }, req: 'ammo_1' },
            { id: 'torp_1', name: 'Firepower +1', desc: 'Starting torpedoes +1', bonus: { torps: 1 }, req: null },
            { id: 'torp_2', name: 'Firepower II +2', desc: 'Starting torpedoes +2', bonus: { torps: 2 }, req: 'torp_1' },
            { id: 'sonar_1', name: 'Knowledge +1', desc: 'Starting sonar +1', bonus: { sonar: 1 }, req: null },
            { id: 'sonar_2', name: 'Knowledge II +2', desc: 'Starting sonar +2', bonus: { sonar: 2 }, req: 'sonar_1' }
        ];

        // --- Persistent Global State ---
        let gameMode = 'campaign'; 
        let playerUpgrades = [];
        let salvagedAmmo = 0;
        let rerollCost = 1;
        let mapData = Array(5).fill().map(() => Array(5).fill('locked'));
        let playerPos = {r: 0, c: 0};

        // --- Local Level State ---
        let grid = [];
        let shots = 30;
        let hits = 0;
        let sonarCharges = 3;
        let torpedoCharges = 2;
        let busterCharges = 0;
        let currentShipTypes = [];
        let totalShipSegments = 0;
        let shipData = [];
        let gameActive = false;
        let currentMode = 'shoot';
        let pendingTorpedoOrigin = null;
        let currentWeather = 'Clear Skies';
        let nextWeather = 'Dense Fog';
        let weatherCounter = 10;
        let isGlobalFog = false;
        let selectedSub = 'Nautilus';
        let currentMissionPos = null;

        // --- Telemetry Log Function ---
        function logEvent(msg, type = 'info') {
            const logContainer = document.getElementById('battle-log');
            if (!logContainer) return;
            
            const colors = {
                'info': 'text-blue-400 border-blue-900',
                'hit': 'text-red-500 border-red-900 bg-red-950/20',
                'miss': 'text-slate-500 border-slate-800',
                'salvage': 'text-emerald-400 border-emerald-900 bg-emerald-950/20',
                'weapon': 'text-amber-500 border-amber-900',
                'warning': 'text-orange-500 border-orange-900 font-bold animate-pulse'
            };

            const entry = document.createElement('div');
            entry.className = `log-entry p-2 bg-slate-950/40 rounded text-[10px] ${colors[type] || colors.info}`;
            
            const timestamp = new Date().toLocaleTimeString([], { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
            entry.innerHTML = `<span class="text-[8px] opacity-30 mr-2">${timestamp}</span> ${msg}`;
            
            logContainer.prepend(entry);
            logContainer.scrollTop = 0;
        }

        function clearLog() {
            const logContainer = document.getElementById('battle-log');
            if(logContainer) logContainer.innerHTML = '';
        }

        // --- Navigation ---
        function showScreen(screenId) {
            ['title', 'overworld', 'deployment', 'game', 'reward'].forEach(s => {
                const el = document.getElementById(`${s}-screen`);
                if(el) el.classList.add('hidden');
            });
            const targetEl = document.getElementById(`${screenId}-screen`);
            if(targetEl) targetEl.classList.remove('hidden');
            
            if (screenId === 'overworld') renderOverworld();
            if (screenId === 'reward') generateRewards();
        }

        function mainMenu() {
            document.getElementById('overlay').classList.add('hidden');
            showScreen('title');
        }

        function initArcade() {
            gameMode = 'arcade';
            playerUpgrades = [];
            salvagedAmmo = 0;
            currentMissionPos = {r: 1, c: 1};
            document.getElementById('return-map-btn').classList.add('hidden');
            document.getElementById('mode-tag-display').innerText = "ARCADE INTERFACE // SINGLE ENGAGEMENT";
            showBriefing(1, 1);
        }

        function initCampaign() {
            gameMode = 'campaign';
            playerUpgrades = [];
            salvagedAmmo = 0;
            playerPos = {r: 0, c: 0};
            mapData = Array(5).fill().map(() => Array(5).fill('locked'));
            mapData[0][0] = 'current';
            document.getElementById('return-map-btn').classList.remove('hidden');
            document.getElementById('mode-tag-display').innerText = "TACTICAL INTERFACE // CAMPAIGN DEPLOYED";
            showScreen('overworld');
        }

        function renderOverworld() {
            const container = document.getElementById('overworld-grid');
            if(!container) return;
            container.innerHTML = '';
            for(let r=0; r<5; r++) {
                for(let c=0; c<5; c++) {
                    const status = mapData[r][c];
                    const isReachable = !['current', 'visited'].includes(status) && isAdjacentToVisited(r, c);
                    if (isReachable && status === 'locked') mapData[r][c] = 'mission';
                    const tile = document.createElement('div');
                    tile.className = `map-tile rounded-lg border-2 ${getTileClass(r, c)}`;
                    if (r === 0 && c === 0 && (mapData[0][0] === 'current' || mapData[0][0] === 'visited')) {
                        tile.innerHTML = '<span class="text-[10px] font-black text-emerald-400">HQ</span>';
                    } else if (mapData[r][c] === 'locked') {
                        tile.innerHTML = '<span class="text-xl font-bold opacity-20">?</span>';
                    } else if (mapData[r][c] === 'mission') {
                        const dist = r + c;
                        tile.innerHTML = `<span class="text-[10px] font-bold text-amber-500">SIG</span><span class="text-[7px] opacity-50">Dist ${dist}</span>`;
                        tile.onclick = () => showBriefing(r, c);
                    } else if (mapData[r][c] === 'current') {
                        tile.innerHTML = '<span class="text-sm">âš“</span>';
                    } else if (mapData[r][c] === 'visited') {
                        tile.innerHTML = '<span class="text-[8px] text-slate-600 uppercase">Clear</span>';
                    }
                    container.appendChild(tile);
                }
            }
            document.getElementById('salvaged-ammo-display').innerText = salvagedAmmo;
            document.getElementById('active-upgrades-list').innerText = playerUpgrades.length > 0 
                ? playerUpgrades.map(u => UPGRADES.find(ref => ref.id === u).name).join(', ') 
                : 'None';
        }

        function isAdjacentToVisited(r, c) {
            const neighbors = [[r-1, c], [r+1, c], [r, c-1], [r, c+1]];
            return neighbors.some(([nr, nc]) => nr >= 0 && nr < 5 && nc >= 0 && nc < 5 && (mapData[nr][nc] === 'visited' || mapData[nr][nc] === 'current'));
        }

        function getTileClass(r, c) {
            const status = mapData[r][c];
            if (status === 'current') return 'tile-hq tile-current';
            if (status === 'mission') return 'tile-mission';
            if (status === 'visited') return 'tile-visited';
            return 'tile-locked';
        }

        function showBriefing(r, c) {
            currentMissionPos = {r, c};
            const dist = r + c;
            document.getElementById('mission-coord-display').innerText = gameMode === 'arcade' ? `ARCADE SCENARIO` : `Sector [${r+1}-${c+1}]`;
            const extraShips = Math.floor(dist / 3);
            currentShipTypes = [...BASE_FLEET];
            for(let i=0; i<extraShips; i++) currentShipTypes.push(2);
            totalShipSegments = currentShipTypes.reduce((a, b) => a + b, 0);
            document.getElementById('brief-weather').innerText = `${WEATHER_TYPES[Math.floor(Math.random() * WEATHER_TYPES.length)]} Patterns`;
            document.getElementById('brief-fleet').innerText = `${currentShipTypes.length} Signatures Detected`;
            document.getElementById('brief-threat').innerText = dist > 6 ? "Critical" : (dist > 3 ? "Elevated" : "Standard");
            renderSubSelection();
            showScreen('deployment');
        }

        function renderSubSelection() {
            const container = document.getElementById('sub-selection-container');
            container.innerHTML = '';
            const subs = [
                { id: 'Nautilus', ammo: 35, sonar: 5, torp: 1, color: 'emerald', tag: 'INTEL' },
                { id: 'The Kraken', ammo: 25, sonar: 2, torp: 5, color: 'amber', tag: 'OFFENSE' },
                { id: 'Ghost-6', ammo: 30, sonar: 3, torp: 2, color: 'indigo', tag: 'STEALTH' },
                { id: 'The Scavenger', ammo: 20, sonar: 2, torp: 2, color: 'rose', tag: 'SALVAGE' }
            ];
            const bonusAmmo = playerUpgrades.reduce((sum, id) => sum + (UPGRADES.find(u => u.id === id).bonus.shots || 0), 0);
            const bonusSonar = playerUpgrades.reduce((sum, id) => sum + (UPGRADES.find(u => u.id === id).bonus.sonar || 0), 0);
            const bonusTorp = playerUpgrades.reduce((sum, id) => sum + (UPGRADES.find(u => u.id === id).bonus.torps || 0), 0);
            subs.forEach(sub => {
                const card = document.createElement('div');
                card.onclick = () => selectSub(sub.id);
                card.className = 'sub-card p-4 rounded-lg bg-slate-800/50';
                card.innerHTML = `<div class="flex justify-between items-start mb-2"><h3 class="text-${sub.color}-400 font-bold uppercase text-xs">${sub.id}</h3><span class="text-[8px] bg-${sub.color}-900/50 text-${sub.color}-300 px-1 rounded">${sub.tag}</span></div><div class="space-y-1"><div class="stat-row"><span class="text-slate-500">Ammo</span><span class="font-bold">${sub.ammo + bonusAmmo}</span></div><div class="stat-row"><span class="text-slate-500">Sonar</span><span class="font-bold">${sub.sonar + bonusSonar}</span></div><div class="stat-row"><span class="text-slate-500">Torp</span><span class="font-bold">${sub.torp + bonusTorp}</span></div></div>`;
                container.appendChild(card);
            });
        }

        function generateRewards() {
            rerollCost = 1;
            document.getElementById('reroll-cost').innerText = rerollCost;
            refreshRewardDisplay();
        }

        function refreshRewardDisplay() {
            const container = document.getElementById('reward-options-container');
            container.innerHTML = '';
            const available = UPGRADES.filter(u => {
                if (playerUpgrades.includes(u.id)) return false;
                if (u.req && !playerUpgrades.includes(u.req)) return false;
                return true;
            });
            const shuffled = [...available].sort(() => 0.5 - Math.random());
            const options = shuffled.slice(0, 3);
            options.forEach(opt => {
                const card = document.createElement('div');
                card.onclick = () => applyUpgrade(opt.id);
                card.className = 'reward-card bg-slate-900 p-6 rounded-xl text-center border border-slate-700';
                card.innerHTML = `<h3 class="text-amber-400 font-bold uppercase text-sm mb-2">${opt.name}</h3><p class="text-xs text-slate-400">${opt.desc}</p><div class="mt-4 text-[10px] text-emerald-500 font-bold uppercase">Click to Claim</div>`;
                container.appendChild(card);
            });
            document.getElementById('reroll-btn').disabled = salvagedAmmo < rerollCost;
        }

        function rerollRewards() {
            if (salvagedAmmo >= rerollCost) {
                salvagedAmmo -= rerollCost;
                rerollCost *= 2;
                document.getElementById('salvaged-ammo-display').innerText = salvagedAmmo;
                document.getElementById('reroll-cost').innerText = rerollCost;
                refreshRewardDisplay();
            }
        }

        function applyUpgrade(upgradeId) {
            playerUpgrades.push(upgradeId);
            mapData[currentMissionPos.r][currentMissionPos.c] = 'visited';
            for(let r=0; r<5; r++) for(let c=0; c<5; c++) if(mapData[r][c] === 'current') mapData[r][c] = 'visited';
            playerPos = {r: currentMissionPos.r, c: currentMissionPos.c};
            mapData[playerPos.r][playerPos.c] = 'current';
            showScreen('overworld');
        }

        function selectSub(name) {
            selectedSub = name;
            startMission();
        }

        function startMission() {
            showScreen('game');
            clearLog();
            logEvent(`Mission initialized. Deployment of ${selectedSub} sub successful.`, 'info');
            document.getElementById('sub-name-display').innerText = selectedSub;
            if (selectedSub === 'Nautilus') { shots = 35; sonarCharges = 5; torpedoCharges = 1; }
            else if (selectedSub === 'The Kraken') { shots = 25; sonarCharges = 2; torpedoCharges = 5; }
            else if (selectedSub === 'Ghost-6') { shots = 30; sonarCharges = 3; torpedoCharges = 2; }
            else if (selectedSub === 'The Scavenger') { shots = 20; sonarCharges = 2; torpedoCharges = 2; }
            shots += playerUpgrades.reduce((sum, id) => sum + (UPGRADES.find(u => u.id === id).bonus.shots || 0), 0);
            sonarCharges += playerUpgrades.reduce((sum, id) => sum + (UPGRADES.find(u => u.id === id).bonus.sonar || 0), 0);
            torpedoCharges += playerUpgrades.reduce((sum, id) => sum + (UPGRADES.find(u => u.id === id).bonus.torps || 0), 0);
            grid = Array(GRID_SIZE).fill().map(() => Array(GRID_SIZE).fill().map(() => ({ isShip: false, revealed: false, neighborShips: 0, shipId: null })));
            shipData = currentShipTypes.map((size, index) => ({ id: index, size, health: size, isSunk: false, coords: [] }));
            hits = 0; busterCharges = 0; weatherCounter = 10;
            currentWeather = 'Clear Skies';
            nextWeather = WEATHER_TYPES[Math.floor(Math.random() * WEATHER_TYPES.length)];
            isGlobalFog = false; gameActive = true; currentMode = 'shoot';
            placeShips(); calculateNeighbors(); renderGrid(); updateUI();
        }

        function abortMatch() {
            if (gameMode === 'arcade') mainMenu(); else showScreen('overworld');
        }

        function placeShips() {
            shipData.forEach((ship) => {
                let placed = false; let attempts = 0;
                while (!placed && attempts < 1000) {
                    const isHorizontal = Math.random() < 0.5;
                    const r = Math.floor(Math.random() * (GRID_SIZE - (isHorizontal ? 0 : ship.size)));
                    const c = Math.floor(Math.random() * (GRID_SIZE - (isHorizontal ? ship.size : 0)));
                    if (canPlace(r, c, ship.size, isHorizontal)) {
                        for (let i = 0; i < ship.size; i++) {
                            const row = isHorizontal ? r : r + i;
                            const col = isHorizontal ? c + i : c;
                            grid[row][col].isShip = true; grid[row][col].shipId = ship.id; ship.coords.push({r: row, c: col});
                        }
                        placed = true;
                    }
                    attempts++;
                }
            });
        }

        function canPlace(r, c, len, horizontal) {
            for (let i = 0; i < len; i++) {
                const currR = horizontal ? r : r + i;
                const actualC = horizontal ? c + i : c;
                for (let dr = -1; dr <= 1; dr++) {
                    for (let dc = -1; dc <= 1; dc++) {
                        const checkR = currR + dr, checkC = actualC + dc;
                        if (checkR >= 0 && checkR < GRID_SIZE && checkC >= 0 && checkC < GRID_SIZE) {
                            if (grid[checkR][checkC].isShip) return false;
                        }
                    }
                }
            }
            return true;
        }

        function calculateNeighbors() {
            for (let r = 0; r < GRID_SIZE; r++) {
                for (let c = 0; c < GRID_SIZE; c++) {
                    if (grid[r][c].isShip) continue;
                    let count = 0;
                    for (let dr = -1; dr <= 1; dr++) {
                        for (let dc = -1; dc <= 1; dc++) {
                            const nr = r + dr, nc = c + dc;
                            if (nr >= 0 && nr < GRID_SIZE && nc >= 0 && nc < GRID_SIZE) if (grid[nr][nc].isShip) count++;
                        }
                    }
                    grid[r][c].neighborShips = count;
                }
            }
        }

        function renderGrid() {
            const container = document.getElementById('game-grid');
            if(!container) return;
            container.style.gridTemplateColumns = `repeat(${GRID_SIZE}, 1fr)`;
            container.innerHTML = '';
            for (let r = 0; r < GRID_SIZE; r++) {
                for (let c = 0; c < GRID_SIZE; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell border border-slate-800/40 flex items-center justify-center font-bold cell-hidden';
                    cell.id = `cell-${r}-${c}`;
                    cell.onclick = () => handleCellClick(r, c);
                    container.appendChild(cell);
                }
            }
        }

        function handleCellClick(r, c) {
            if (!gameActive) return;
            const data = grid[r][c];
            const isJammed = currentWeather === 'Electrical Storm' && selectedSub !== 'Ghost-6';
            if (currentMode === 'sonar') {
                if (data.revealed || isJammed) return;
                performSonar(r, c);
            } else if (currentMode === 'torpedo' || currentMode === 'buster') {
                pendingTorpedoOrigin = {r, c};
                document.getElementById('dir-selector').classList.remove('hidden');
            } else {
                if (data.revealed) return;
                const isHit = data.isShip;
                revealCell(r, c);
                logEvent(`Battery fired at Sector [${r+1},${c+1}]... ${isHit ? 'DIRECT HIT!' : 'Miss.'}`, isHit ? 'hit' : 'miss');
                shots--;
                weatherCounter--;
                if (weatherCounter <= 0) changeWeather();
                checkGameOver();
                updateUI();
            }
        }

        function changeWeather() {
            currentWeather = nextWeather;
            nextWeather = WEATHER_TYPES[Math.floor(Math.random() * WEATHER_TYPES.length)];
            weatherCounter = 10;
            isGlobalFog = (currentWeather === 'Dense Fog');
            logEvent(`Atmospheric Shift: ${currentWeather.toUpperCase()} confirmed.`, currentWeather === 'Clear Skies' ? 'info' : 'warning');
            renderWeatherEffects();
        }

        function renderWeatherEffects() {
            document.querySelectorAll('.fog-overlay').forEach(el => el.remove());
            if (isGlobalFog) {
                for(let r=0; r<GRID_SIZE; r++) {
                    for(let c=0; c<GRID_SIZE; c++) {
                        const cell = document.getElementById(`cell-${r}-${c}`);
                        if(cell) { const fog = document.createElement('div'); fog.className = 'fog-overlay'; cell.appendChild(fog); }
                    }
                }
            }
            for(let r=0; r<GRID_SIZE; r++) {
                for(let c=0; c<GRID_SIZE; c++) {
                    const data = grid[r][c];
                    if (data.revealed && !data.isShip) {
                        const cellEl = document.getElementById(`cell-${r}-${c}`);
                        if (cellEl && data.neighborShips > 0) {
                            const isObscured = isGlobalFog && selectedSub !== 'Ghost-6';
                            cellEl.innerText = isObscured ? '?' : data.neighborShips;
                            cellEl.style.color = isObscured ? '#94a3b8' : getNumberColor(data.neighborShips);
                        }
                    }
                }
            }
        }

        function revealCell(r, c, isFree = false) {
            if (r < 0 || r >= GRID_SIZE || c < 0 || c >= GRID_SIZE) return;
            const data = grid[r][c];
            if (data.revealed) return;
            data.revealed = true;
            const cellEl = document.getElementById(`cell-${r}-${c}`);
            if(cellEl) cellEl.classList.remove('cell-hidden');
            if (data.isShip) {
                hits++;
                if(cellEl) { cellEl.classList.add('cell-revealed-ship'); cellEl.innerHTML = 'ðŸ’¥'; }
                const ship = shipData[data.shipId];
                ship.health--;
                if (ship.size === 3 && !isFree) revealRandomWater(3);
                if (ship.health <= 0) sinkShip(ship);
            } else {
                if(cellEl) cellEl.classList.add('cell-revealed-water');
                if (data.neighborShips > 0 && cellEl) {
                    const isObscured = isGlobalFog && selectedSub !== 'Ghost-6';
                    cellEl.innerText = isObscured ? '?' : data.neighborShips;
                    cellEl.style.color = isObscured ? '#94a3b8' : getNumberColor(data.neighborShips);
                }
            }
        }

        function revealRandomWater(count) {
            let revealed = 0; let attempts = 0;
            while (revealed < count && attempts < 100) {
                const r = Math.floor(Math.random() * GRID_SIZE);
                const c = Math.floor(Math.random() * GRID_SIZE);
                if (!grid[r][c].isShip && !grid[r][c].revealed) { revealCell(r, c, true); revealed++; }
                attempts++;
            }
            if(revealed > 0) logEvent(`Radar Vessel hit! Intelligence reveals ${revealed} safe coordinates.`, 'salvage');
        }

        function sinkShip(ship) {
            if (ship.isSunk) return;
            ship.isSunk = true;
            const remainingHull = ship.health;
            if (remainingHull > 0) hits += remainingHull;
            ship.health = 0;
            
            const names = ['Carrier', 'Battleship', 'Battleship', 'Radar', 'Radar', 'Corvette', 'Corvette'];
            logEvent(`CRITICAL STRIKE: Enemy ${names[ship.id] || 'Ship'} neutralized!`, 'hit');

            const multiplier = selectedSub === 'The Scavenger' ? 2 : 1;
            if (ship.size === 2) { shots += (5 * multiplier); showStatusText(`+${5*multiplier} AMMO`, "text-emerald-400"); logEvent(`Salvage ops complete: +${5*multiplier} Ammo recovered.`, 'salvage'); }
            if (ship.size === 5) { busterCharges += (1 * multiplier); showStatusText(`${multiplier} BUSTER READY`, "text-red-400"); logEvent(`Flagship wreckage salvaged. ${multiplier} Buster Torpedo(es) armed.`, 'salvage'); }
            
            ship.coords.forEach(coord => {
                const el = document.getElementById(`cell-${coord.r}-${coord.c}`);
                if(el) { el.classList.add('cell-sunk-ship'); el.innerHTML = 'âš“'; el.classList.remove('cell-hidden'); }
                grid[coord.r][coord.c].revealed = true;
            });
            ship.coords.forEach(coord => {
                for (let dr = -1; dr <= 1; dr++) for (let dc = -1; dc <= 1; dc++) {
                    const nr = coord.r + dr, nc = coord.c + dc;
                    if (nr >= 0 && nr < GRID_SIZE && nc >= 0 && nc < GRID_SIZE) if (!grid[nr][nc].isShip) revealCell(nr, nc, true);
                }
            });
            checkGameOver(); updateUI();
        }

        function showStatusText(text, colorClass) {
            const statusText = document.getElementById('status-text');
            if (!statusText) return;
            statusText.innerText = text; statusText.className = `text-[9px] font-bold uppercase ${colorClass}`;
            setTimeout(() => { if (gameActive) { statusText.innerText = "READY"; statusText.className = "text-[9px] font-bold uppercase text-emerald-500"; } }, 3000);
        }

        function performSonar(r, c) {
            if (sonarCharges <= 0 || (currentWeather === 'Electrical Storm' && selectedSub !== 'Ghost-6')) return;
            sonarCharges--; cancelWeapon();
            logEvent(`Sonar ping emitted at [${r+1}, ${c+1}]. Analysing signatures...`, 'weapon');
            for (let dr = -1; dr <= 1; dr++) {
                for (let dc = -1; dc <= 1; dc++) {
                    const nr = r + dr, nc = c + dc;
                    if (nr >= 0 && nr < GRID_SIZE && nc >= 0 && nc < GRID_SIZE) {
                        const cellEl = document.getElementById(`cell-${nr}-${nc}`);
                        const actualCellData = grid[nr][nc];
                        if(cellEl) cellEl.classList.add('cell-sonar');
                        setTimeout(() => {
                            if(cellEl) cellEl.classList.remove('cell-sonar');
                            if (actualCellData.isShip && cellEl) cellEl.innerHTML = '<span class="text-sm scale-110 drop-shadow-lg" style="color: #fbbf24; opacity: 1;">ðŸš¢</span>';
                            else if (!actualCellData.revealed && cellEl) cellEl.innerHTML = '<span class="text-[10px] opacity-20">ðŸŒŠ</span>';
                        }, 1200);
                    }
                }
            }
            updateUI();
        }

        function fireTorpedoActual(dir) {
            const isBuster = (currentMode === 'buster');
            if (isBuster ? busterCharges <= 0 : torpedoCharges <= 0) return;
            isBuster ? busterCharges-- : torpedoCharges--;
            shots -= 2; cancelWeapon();
            const {r, c} = pendingTorpedoOrigin;
            logEvent(`${isBuster ? 'BUSTER' : 'Standard'} Torpedo launched on vector: ${dir.toUpperCase()}.`, 'weapon');
            let currR = r, currC = c, hitTarget = false, path = [];
            while (currR >= 0 && currR < GRID_SIZE && currC >= 0 && currC < GRID_SIZE && !hitTarget) {
                path.push({r: currR, c: currC});
                if (grid[currR][currC].isShip) hitTarget = true;
                if (dir === 'up') currR--; else if (dir === 'down') currR++;
                else if (dir === 'left') currC--; else if (dir === 'right') currC++;
            }
            path.forEach((pos, index) => {
                setTimeout(() => {
                    const cellEl = document.getElementById(`cell-${pos.r}-${pos.c}`);
                    if(cellEl) cellEl.classList.add(isBuster ? 'cell-buster-path' : 'cell-torpedo-path');
                    setTimeout(() => {
                        if(cellEl) cellEl.classList.remove('cell-buster-path', 'cell-torpedo-path');
                        if (index === path.length - 1 && hitTarget) {
                            if (isBuster) {
                                sinkShip(shipData[grid[pos.r][pos.c].shipId]);
                            } else {
                                logEvent(`Torpedo detonation! 3x3 shockwave revealing area.`, 'hit');
                                for (let dr = -1; dr <= 1; dr++) for (let dc = -1; dc <= 1; dc++) revealCell(pos.r + dr, pos.c + dc, true);
                            }
                        } else revealCell(pos.r, pos.c, true);
                        if (index === path.length - 1) { checkGameOver(); updateUI(); }
                    }, 150);
                }, index * 80);
            });
        }

        function getNumberColor(num) {
            const colors = ['', '#60a5fa', '#4ade80', '#fbbf24', '#f87171', '#c084fc', '#2dd4bf', '#f472b6', '#ffffff'];
            return colors[num] || '#fff';
        }

        function updateUI() {
            document.getElementById('shots-count').innerText = shots;
            document.getElementById('sonar-count').innerText = sonarCharges;
            document.getElementById('torpedo-count').innerText = torpedoCharges;
            document.getElementById('buster-count').innerText = busterCharges;
            document.getElementById('weather-text').innerText = currentWeather;
            document.getElementById('next-weather').innerText = `Forecast: ${nextWeather} in ${weatherCounter}`;
            document.getElementById('sonar-btn').disabled = (currentWeather === 'Electrical Storm' && selectedSub !== 'Ghost-6') || sonarCharges <= 0;
            document.getElementById('buster-btn').disabled = busterCharges <= 0;
            document.getElementById('fleet-count').innerText = `${hits}/${totalShipSegments}`;
            const fleetDash = document.getElementById('fleet-dashboard');
            fleetDash.innerHTML = '';
            shipData.forEach(ship => {
                const shipContainer = document.createElement('div');
                shipContainer.className = `ship-indicator ${ship.isSunk ? 'ship-sunk' : ''}`;
                if (ship.size === 5) shipContainer.style.borderColor = '#ef444455';
                for (let i = 0; i < ship.size; i++) {
                    const seg = document.createElement('div');
                    seg.className = 'ship-segment';
                    if (!ship.isSunk && i < (ship.size - ship.health)) seg.style.background = '#94a3b8';
                    shipContainer.appendChild(seg);
                }
                fleetDash.appendChild(shipContainer);
            });
        }

        function checkGameOver() {
            if (hits >= totalShipSegments) endGame(true);
            else if (shots <= 0 && gameActive) endGame(false);
        }

        function endGame(win) {
            gameActive = false;
            logEvent(win ? "VICTORY: Sector cleared of all hostiles." : "DEFEAT: Sector lost due to lack of ordinance.", win ? 'salvage' : 'warning');
            const overlay = document.getElementById('overlay');
            overlay.classList.remove('hidden');
            const title = document.getElementById('overlay-title');
            const msg = document.getElementById('overlay-msg');
            const btn = document.getElementById('end-action-btn');
            if (win) {
                title.innerText = "VICTORY";
                title.className = "text-6xl font-black mb-4 text-emerald-500";
                if (gameMode === 'campaign') {
                    msg.innerText = `Sector secured. ${shots} units of ammo salvaged for fleet upgrades.`;
                    btn.innerText = "Tactical Rewards";
                    btn.onclick = () => { salvagedAmmo += shots; showScreen('reward'); overlay.classList.add('hidden'); };
                } else {
                    msg.innerText = `Scenario complete. Sector clear. Return for new assignment.`;
                    btn.innerText = "Return to Menu"; btn.onclick = () => mainMenu();
                }
            } else {
                title.innerText = "DEFEAT";
                title.className = "text-6xl font-black mb-4 text-red-600";
                msg.innerText = "Critical ammo failure. Enemy vessels escaped.";
                btn.innerText = gameMode === 'campaign' ? "Retry Sector" : "Main Menu";
                btn.onclick = () => { overlay.classList.add('hidden'); if(gameMode === 'campaign') startMission(); else mainMenu(); };
            }
            for(let r=0; r<GRID_SIZE; r++) for(let c=0; c<GRID_SIZE; c++) {
                const cellEl = document.getElementById(`cell-${r}-${c}`);
                const data = grid[r][c];
                if (cellEl && !data.revealed && data.isShip) { cellEl.classList.remove('cell-hidden'); cellEl.classList.add('bg-slate-700/50'); cellEl.innerHTML = 'ðŸš¢'; }
            }
        }

        function cancelWeapon() {
            currentMode = 'shoot';
            ['sonar-btn', 'torpedo-btn', 'buster-btn'].forEach(id => document.getElementById(id).classList.remove('weapon-active'));
            document.getElementById('dir-selector').classList.add('hidden');
            document.getElementById('status-text').innerText = "READY";
            updateUI();
        }

        document.getElementById('sonar-btn').onclick = () => {
            const isJammed = currentWeather === 'Electrical Storm' && selectedSub !== 'Ghost-6';
            if (currentMode === 'sonar') cancelWeapon();
            else if (sonarCharges > 0 && !isJammed) { cancelWeapon(); currentMode = 'sonar'; document.getElementById('sonar-btn').classList.add('weapon-active'); document.getElementById('status-text').innerText = "SONAR ACTIVE"; }
        };
        document.getElementById('torpedo-btn').onclick = () => {
            if (currentMode === 'torpedo') cancelWeapon();
            else if (torpedoCharges > 0) { cancelWeapon(); currentMode = 'torpedo'; document.getElementById('torpedo-btn').classList.add('weapon-active'); document.getElementById('status-text').innerText = "TORPEDO ACTIVE"; }
        };
        document.getElementById('buster-btn').onclick = () => {
            if (currentMode === 'buster') cancelWeapon();
            else if (busterCharges > 0) { cancelWeapon(); currentMode = 'buster'; document.getElementById('buster-btn').classList.add('weapon-active'); document.getElementById('status-text').innerText = "BUSTER READY"; }
        };

        window.onload = mainMenu;
    </script>
</body>
</html>
