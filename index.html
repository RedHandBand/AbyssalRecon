<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abyssal Recon: Tactical Command</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap');
        
        body {
            background-color: #0f172a;
            color: #e2e8f0;
            font-family: 'Space Mono', monospace;
            user-select: none;
            overflow-x: hidden;
        }

        #game-grid, #overworld-grid {
            display: grid;
        }

        .grid-cell {
            aspect-ratio: 1 / 1;
            transition: all 0.15s ease;
            font-size: 0.75rem;
            position: relative;
        }

        .cell-hidden {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
        }

        .cell-hidden:hover {
            background: #334155;
            cursor: crosshair;
        }

        .cell-revealed-water {
            background: #0c4a6e;
            color: #7dd3fc;
        }

        .cell-revealed-ship {
            background: #991b1b;
            animation: hit-shake 0.3s ease-in-out;
            z-index: 10;
        }

        .cell-sunk-ship {
            background: #450a0a !important;
            color: #ef4444 !important;
            filter: grayscale(0.2);
        }

        @keyframes hit-shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }

        .cell-sonar {
            background: #065f46 !important;
            box-shadow: inset 0 0 10px #10b981;
            z-index: 20;
        }

        .cell-torpedo-path {
            background: #f59e0b !important;
            box-shadow: 0 0 10px #f59e0b;
            z-index: 20;
        }

        .cell-buster-path {
            background: #ef4444 !important;
            box-shadow: 0 0 20px #ef4444;
            z-index: 20;
        }

        .fog-overlay {
            position: absolute;
            inset: 0;
            background: rgba(148, 163, 184, 0.3);
            backdrop-filter: blur(4px);
            pointer-events: none;
            z-index: 5;
            animation: fog-pulse 6s ease-in-out infinite;
        }

        @keyframes fog-pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 0.8; }
        }

        .radar-sweep {
            position: absolute;
            width: 100%;
            height: 2px;
            background: rgba(16, 185, 129, 0.1);
            top: 0;
            animation: sweep 6s linear infinite;
            pointer-events: none;
            z-index: 30;
        }

        @keyframes sweep {
            from { top: 0; }
            to { top: 100%; }
        }

        .weapon-active {
            border-color: white !important;
            box-shadow: 0 0 15px rgba(255,255,255,0.4);
            transform: translateY(-2px);
        }

        .ship-indicator {
            display: flex;
            gap: 2px;
            padding: 4px;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 4px;
            border: 1px solid transparent;
        }
        
        .ship-segment {
            width: 8px;
            height: 12px;
            background: #475569;
            border-radius: 1px;
        }

        .ship-sunk .ship-segment {
            background: #ef4444;
            opacity: 0.3;
        }
        
        .ship-sunk {
            position: relative;
            border-color: #ef444433 !important;
        }

        .ship-sunk::after {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            width: 100%;
            height: 2px;
            background: #ef4444;
            transform: rotate(-5deg);
        }

        .weather-card {
            background: linear-gradient(to bottom, #1e293b, #0f172a);
            border-left: 4px solid #3b82f6;
        }

        .btn-abort {
            transition: all 0.2s;
            background: #450a0a;
            border: 1px solid #991b1b;
        }
        .btn-abort:hover {
            background: #991b1b;
            color: white;
        }

        .sub-card {
            transition: all 0.3s;
            cursor: pointer;
            border: 1px solid #334155;
        }
        .sub-card:hover {
            background: #1e293b;
            border-color: #10b981;
            transform: translateY(-5px);
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            padding: 2px 0;
        }

        /* Overworld Styles */
        .map-tile {
            aspect-ratio: 1 / 1;
            border: 1px solid #334155;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        .tile-hq {
            background: #064e3b;
            border-color: #10b981;
        }
        .tile-mission {
            background: #1e293b;
            cursor: pointer;
        }
        .tile-mission:hover {
            background: #334155;
            border-color: #fbbf24;
        }
        .tile-locked {
            background: #0f172a;
            opacity: 0.5;
            color: #475569;
        }
        .tile-current {
            box-shadow: inset 0 0 15px #10b981;
            border-color: #10b981;
            z-index: 10;
        }
        .tile-visited {
            background: #0f172a;
            border-color: #1e293b;
            opacity: 0.8;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <!-- Screen 1: Overworld Map -->
    <div id="overworld-screen" class="max-w-2xl w-full flex flex-col items-center">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-black text-emerald-500 uppercase tracking-tighter italic">Abyssal Recon v4.1</h1>
            <p class="text-slate-500 font-bold tracking-widest text-xs mt-2 uppercase">Theater of Operations</p>
        </div>

        <div id="overworld-grid" class="grid grid-cols-5 gap-2 w-full bg-slate-900 p-4 rounded-xl border border-slate-800 shadow-2xl">
            <!-- Generated by JS -->
        </div>

        <div class="mt-8 text-center bg-slate-800/50 p-4 rounded border border-slate-700 w-full">
            <p class="text-[10px] text-slate-400 uppercase font-bold mb-1">Strategic Note</p>
            <p class="text-xs text-slate-500 italic">Select an adjacent mission tile to begin deployment. Neutralizing sectors expands our naval reach.</p>
        </div>
    </div>

    <!-- Screen 2: Deployment Phase (Selection & Briefing) -->
    <div id="deployment-screen" class="hidden max-w-4xl w-full flex flex-col items-center">
        <div class="text-center mb-10">
            <h1 class="text-4xl font-black text-emerald-500 uppercase tracking-tighter italic">Mission Briefing</h1>
            <p id="mission-coord-display" class="text-slate-500 font-bold tracking-widest text-xs mt-2 uppercase">Sector [0,0]</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 w-full">
            <div class="md:col-span-1 bg-slate-900 border border-slate-700 p-6 rounded-lg self-start">
                <h2 class="text-emerald-400 font-bold uppercase text-sm mb-4 border-b border-slate-700 pb-2">Intelligence</h2>
                <div class="space-y-4">
                    <div>
                        <p class="text-[10px] text-slate-500 uppercase">Sector Weather</p>
                        <p id="brief-weather" class="text-sm font-bold text-blue-400 uppercase">Heavy Fog Patterns</p>
                    </div>
                    <div>
                        <p class="text-[10px] text-slate-500 uppercase">Fleet Signatures</p>
                        <p id="brief-fleet" class="text-sm font-bold text-red-400 uppercase tracking-tighter">7 Confirmed Signatures</p>
                    </div>
                    <div>
                        <p class="text-[10px] text-slate-500 uppercase">Strategic Objective</p>
                        <p class="text-[10px] text-slate-400 italic">"Intercept the fleet before they breach the sector perimeterâ€”zero escape tolerance."</p>
                    </div>
                </div>
                <button onclick="showScreen('overworld')" class="mt-6 w-full py-2 border border-slate-700 rounded text-[10px] uppercase font-bold hover:bg-slate-800">Return to Map</button>
            </div>

            <div class="md:col-span-2 space-y-4">
                <h2 class="text-slate-300 font-bold uppercase text-sm mb-2">Select your submarine</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div onclick="selectSub('Nautilus')" class="sub-card p-4 rounded-lg bg-slate-800/50">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-emerald-400 font-bold uppercase text-xs">Nautilus</h3>
                            <span class="text-[8px] bg-emerald-900/50 text-emerald-300 px-1 rounded">INTEL</span>
                        </div>
                        <div class="space-y-1 mb-3">
                            <div class="stat-row"><span class="text-slate-500">Ammo</span><span class="font-bold">35</span></div>
                            <div class="stat-row"><span class="text-slate-500">Sonar</span><span class="font-bold">5</span></div>
                            <div class="stat-row"><span class="text-slate-500">Torp</span><span class="font-bold">1</span></div>
                        </div>
                    </div>
                    <div onclick="selectSub('The Kraken')" class="sub-card p-4 rounded-lg bg-slate-800/50">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-amber-400 font-bold uppercase text-xs">The Kraken</h3>
                            <span class="text-[8px] bg-amber-900/50 text-amber-300 px-1 rounded">OFFENSE</span>
                        </div>
                        <div class="space-y-1 mb-3">
                            <div class="stat-row"><span class="text-slate-500">Ammo</span><span class="font-bold">25</span></div>
                            <div class="stat-row"><span class="text-slate-500">Sonar</span><span class="font-bold">2</span></div>
                            <div class="stat-row"><span class="text-slate-500">Torp</span><span class="font-bold">5</span></div>
                        </div>
                    </div>
                    <div onclick="selectSub('Ghost-6')" class="sub-card p-4 rounded-lg bg-slate-800/50">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-indigo-400 font-bold uppercase text-xs">Ghost-6</h3>
                            <span class="text-[8px] bg-indigo-900/50 text-indigo-300 px-1 rounded">STEALTH</span>
                        </div>
                        <div class="space-y-1 mb-3">
                            <div class="stat-row"><span class="text-slate-500">Ammo</span><span class="font-bold">30</span></div>
                            <div class="stat-row"><span class="text-slate-500">Sonar</span><span class="font-bold">3</span></div>
                            <div class="stat-row"><span class="text-slate-500">Torp</span><span class="font-bold">2</span></div>
                        </div>
                    </div>
                    <div onclick="selectSub('The Scavenger')" class="sub-card p-4 rounded-lg bg-slate-800/50">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-rose-400 font-bold uppercase text-xs">The Scavenger</h3>
                            <span class="text-[8px] bg-rose-900/50 text-rose-300 px-1 rounded">SALVAGE</span>
                        </div>
                        <div class="space-y-1 mb-3">
                            <div class="stat-row"><span class="text-slate-500">Ammo</span><span class="font-bold">20</span></div>
                            <div class="stat-row"><span class="text-slate-500">Sonar</span><span class="font-bold">2</span></div>
                            <div class="stat-row"><span class="text-slate-500">Torp</span><span class="font-bold">2</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Screen 3: Tactical Interface -->
    <div id="game-screen" class="hidden max-w-3xl w-full">
        <div class="mb-4">
            <div class="flex justify-between items-end border-b border-slate-700 pb-2">
                <div>
                    <h1 id="sub-name-display" class="text-2xl font-bold text-emerald-500 uppercase tracking-tighter">Nautilus</h1>
                    <p class="text-[10px] text-slate-400 font-bold tracking-widest">TACTICAL INTERFACE // DEPLOYED</p>
                </div>
                <div class="text-right">
                    <div class="text-xl font-bold flex items-center justify-end gap-2">
                        <span id="shots-count">30</span> 
                        <svg class="w-5 h-5 text-orange-500" fill="currentColor" viewBox="0 0 24 24"><path d="M12,2L4.5,20.29L5.21,21L12,18L18.79,21L19.5,20.29L12,2Z"/></svg>
                    </div>
                    <div class="text-[10px] uppercase text-slate-500 tracking-widest">Ammunition</div>
                </div>
            </div>

            <div id="fleet-dashboard" class="flex flex-wrap gap-3 mt-3 bg-slate-900/50 p-3 rounded border border-slate-800"></div>

            <div class="grid grid-cols-6 gap-2 mt-3">
                <div class="weather-card p-2 rounded border border-slate-700 flex flex-col justify-center col-span-2">
                    <div class="text-[10px] text-slate-400 uppercase font-bold tracking-tighter">Weather Systems</div>
                    <div id="weather-text" class="text-xs font-bold text-blue-400 uppercase">Clear Skies</div>
                    <div id="next-weather" class="text-[9px] font-bold text-slate-500 uppercase mt-1 tracking-tight">Forecast: Loading...</div>
                </div>
                <button id="sonar-btn" class="bg-emerald-900/50 hover:bg-emerald-800 p-2 rounded border border-emerald-700 transition-all disabled:opacity-30 col-span-1">
                    <div class="text-[10px] text-emerald-300 uppercase">Sonar</div>
                    <div id="sonar-count" class="text-lg font-bold text-emerald-400">3</div>
                </button>
                <button id="torpedo-btn" class="bg-amber-900/50 hover:bg-amber-800 p-2 rounded border border-amber-700 transition-all col-span-1">
                    <div class="text-[10px] text-amber-300 uppercase">Torp</div>
                    <div id="torpedo-count" class="text-lg font-bold text-amber-400">2</div>
                </button>
                <button id="buster-btn" class="bg-red-900/30 hover:bg-red-900/50 p-2 rounded border border-red-900 transition-all col-span-1 disabled:opacity-20">
                    <div class="text-[10px] text-red-400 uppercase">Buster</div>
                    <div id="buster-count" class="text-lg font-bold text-red-500">0</div>
                </button>
                <div class="bg-slate-800 p-2 rounded border border-slate-700 flex flex-col justify-between col-span-1">
                    <div>
                        <div class="text-[10px] text-slate-400 uppercase">Hull</div>
                        <div id="fleet-count" class="text-xs font-bold text-red-400 tracking-tighter">0/0</div>
                    </div>
                    <div>
                        <div id="status-text" class="text-[9px] font-bold text-emerald-500 uppercase">Ready</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="relative p-1 bg-slate-800 rounded shadow-2xl border border-slate-700 overflow-hidden">
            <div class="radar-sweep"></div>
            <div id="game-grid" class="gap-px bg-slate-900 border border-slate-900" style="width: min(95vw, 600px);"></div>
            <div id="dir-selector" class="hidden absolute inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm">
                <div class="bg-slate-800 p-4 rounded-lg border border-amber-500 shadow-2xl text-center">
                    <p id="target-vector-text" class="text-amber-500 font-bold mb-4 uppercase text-sm">Target Vector</p>
                    <div class="grid grid-cols-3 gap-2">
                        <div></div><button onclick="fireTorpedoActual('up')" class="p-3 bg-slate-700 hover:bg-amber-600 rounded">â–²</button><div></div>
                        <button onclick="fireTorpedoActual('left')" class="p-3 bg-slate-700 hover:bg-amber-600 rounded">â—€</button>
                        <button onclick="cancelWeapon()" class="p-3 bg-red-900/50 hover:bg-red-600 rounded text-xs">X</button>
                        <button onclick="fireTorpedoActual('right')" class="p-3 bg-slate-700 hover:bg-amber-600 rounded">â–¶</button>
                        <div></div><button onclick="fireTorpedoActual('down')" class="p-3 bg-slate-700 hover:bg-amber-600 rounded">â–¼</button><div></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-4 flex flex-col items-center gap-4">
            <button onclick="showScreen('overworld')" class="btn-abort text-[10px] px-8 py-2 rounded font-bold text-red-400 uppercase tracking-widest border border-red-900/30">
                Abort Mission
            </button>
        </div>
    </div>

    <div id="overlay" class="hidden fixed inset-0 bg-slate-900/95 flex flex-col items-center justify-center z-[100] p-6 text-center">
        <h2 id="overlay-title" class="text-6xl font-black mb-4 tracking-tighter">DEFEAT</h2>
        <p id="overlay-msg" class="text-xl text-slate-400 mb-8 max-w-md"></p>
        <button id="end-action-btn" onclick="initGame()" class="bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-4 px-12 rounded-full transition-all transform hover:scale-105 shadow-lg shadow-emerald-900/20 uppercase tracking-widest">
            Redeploy Fleet
        </button>
    </div>

    <script>
        const GRID_SIZE = 15;
        const SHIP_TYPES = [5, 4, 4, 3, 3, 2, 2];
        const WEATHER_TYPES = ['Clear Skies', 'Dense Fog', 'Electrical Storm'];
        
        // Game Logic State
        let grid = [];
        let shots = 30;
        let hits = 0;
        let sonarCharges = 3;
        let torpedoCharges = 2;
        let busterCharges = 0;
        let totalShipSegments = SHIP_TYPES.reduce((a, b) => a + b, 0);
        let shipData = [];
        let gameActive = false;
        let currentMode = 'shoot';
        let pendingTorpedoOrigin = null;
        let currentWeather = 'Clear Skies';
        let nextWeather = 'Dense Fog';
        let weatherCounter = 10;
        let isGlobalFog = false;
        let selectedSub = 'Nautilus';

        // Overworld State
        let playerPos = {r: 0, c: 0};
        let mapData = Array(5).fill().map(() => Array(5).fill('locked'));
        mapData[0][0] = 'current';

        const screens = ['overworld', 'deployment', 'game'];

        function showScreen(screenId) {
            screens.forEach(s => {
                const el = document.getElementById(`${s}-screen`);
                if(el) el.classList.add('hidden');
            });
            const targetEl = document.getElementById(`${screenId}-screen`);
            if(targetEl) targetEl.classList.remove('hidden');
            if (screenId === 'overworld') renderOverworld();
        }

        function renderOverworld() {
            const container = document.getElementById('overworld-grid');
            if(!container) return;
            container.innerHTML = '';
            
            for(let r=0; r<5; r++) {
                for(let c=0; c<5; c++) {
                    const tile = document.createElement('div');
                    const status = mapData[r][c];
                    const isReachable = !['current', 'visited'].includes(status) && isAdjacentToVisited(r, c);
                    if (isReachable && status === 'locked') mapData[r][c] = 'mission';
                    
                    tile.className = `map-tile rounded-lg border-2 ${getTileClass(r, c)}`;
                    
                    if (r === 0 && c === 0 && mapData[0][0] === 'current') {
                        tile.innerHTML = '<span class="text-[10px] font-black text-emerald-400">HQ</span>';
                    } else if (mapData[r][c] === 'locked') {
                        tile.innerHTML = '<span class="text-xl font-bold opacity-20">?</span>';
                    } else if (mapData[r][c] === 'mission') {
                        tile.innerHTML = '<span class="text-[10px] font-bold text-amber-500">SIG</span><span class="text-[8px] opacity-50">Detected</span>';
                        tile.onclick = () => showBriefing(r, c);
                    } else if (mapData[r][c] === 'current') {
                        tile.innerHTML = '<span class="text-sm">âš“</span>';
                    } else if (mapData[r][c] === 'visited') {
                        tile.innerHTML = '<span class="text-[8px] text-slate-600 uppercase">Clear</span>';
                    }
                    container.appendChild(tile);
                }
            }
        }

        function isAdjacentToVisited(r, c) {
            const neighbors = [[r-1, c], [r+1, c], [r, c-1], [r, c+1]];
            return neighbors.some(([nr, nc]) => {
                return nr >= 0 && nr < 5 && nc >= 0 && nc < 5 && 
                       (mapData[nr][nc] === 'visited' || mapData[nr][nc] === 'current');
            });
        }

        function getTileClass(r, c) {
            const status = mapData[r][c];
            if (status === 'current') return 'tile-hq tile-current';
            if (status === 'mission') return 'tile-mission';
            if (status === 'visited') return 'tile-visited';
            return 'tile-locked';
        }

        let currentMissionPos = null;

        function showBriefing(r, c) {
            currentMissionPos = {r, c};
            const coordEl = document.getElementById('mission-coord-display');
            if(coordEl) coordEl.innerText = `Sector [${r+1}-${c+1}]`;
            
            const randWeather = WEATHER_TYPES[Math.floor(Math.random() * WEATHER_TYPES.length)];
            const briefWeatherEl = document.getElementById('brief-weather');
            const briefFleetEl = document.getElementById('brief-fleet');
            if(briefWeatherEl) briefWeatherEl.innerText = `${randWeather} Patterns`;
            if(briefFleetEl) briefFleetEl.innerText = `${SHIP_TYPES.length} Confirmed Signatures`;
            
            showScreen('deployment');
        }

        function selectSub(name) {
            selectedSub = name;
            startMission();
        }

        function startMission() {
            showScreen('game');
            const subDisplay = document.getElementById('sub-name-display');
            if(subDisplay) subDisplay.innerText = selectedSub;
            
            if (selectedSub === 'Nautilus') { shots = 35; sonarCharges = 5; torpedoCharges = 1; }
            else if (selectedSub === 'The Kraken') { shots = 25; sonarCharges = 2; torpedoCharges = 5; }
            else if (selectedSub === 'Ghost-6') { shots = 30; sonarCharges = 3; torpedoCharges = 2; }
            else if (selectedSub === 'The Scavenger') { shots = 20; sonarCharges = 2; torpedoCharges = 2; }

            grid = Array(GRID_SIZE).fill().map(() => Array(GRID_SIZE).fill().map(() => ({
                isShip: false, revealed: false, neighborShips: 0, shipId: null
            })));

            shipData = SHIP_TYPES.map((size, index) => ({
                id: index, size, health: size, isSunk: false, coords: []
            }));

            hits = 0; busterCharges = 0; weatherCounter = 10;
            currentWeather = 'Clear Skies';
            nextWeather = WEATHER_TYPES[Math.floor(Math.random() * WEATHER_TYPES.length)];
            isGlobalFog = false; gameActive = true; currentMode = 'shoot';
            
            placeShips();
            calculateNeighbors();
            renderGrid();
            updateUI();
        }

        function initGame() {
            playerPos = {r: 0, c: 0};
            mapData = Array(5).fill().map(() => Array(5).fill('locked'));
            mapData[0][0] = 'current';
            showScreen('overworld');
            const overlay = document.getElementById('overlay');
            if(overlay) overlay.classList.add('hidden');
        }

        function placeShips() {
            shipData.forEach((ship) => {
                let placed = false;
                let attempts = 0;
                while (!placed && attempts < 1000) {
                    const isHorizontal = Math.random() < 0.5;
                    const r = Math.floor(Math.random() * (GRID_SIZE - (isHorizontal ? 0 : ship.size)));
                    const c = Math.floor(Math.random() * (GRID_SIZE - (isHorizontal ? ship.size : 0)));
                    if (canPlace(r, c, ship.size, isHorizontal)) {
                        for (let i = 0; i < ship.size; i++) {
                            const row = isHorizontal ? r : r + i;
                            const col = isHorizontal ? c + i : c;
                            grid[row][col].isShip = true;
                            grid[row][col].shipId = ship.id;
                            ship.coords.push({r: row, c: col});
                        }
                        placed = true;
                    }
                    attempts++;
                }
            });
        }

        function canPlace(r, c, len, horizontal) {
            for (let i = 0; i < len; i++) {
                const currR = horizontal ? r : r + i;
                const currC = horizontal ? c : c; // Corrected: was c + i only if horizontal
                const actualC = horizontal ? c + i : c;
                for (let dr = -1; dr <= 1; dr++) {
                    for (let dc = -1; dc <= 1; dc++) {
                        const checkR = currR + dr, checkC = actualC + dc;
                        if (checkR >= 0 && checkR < GRID_SIZE && checkC >= 0 && checkC < GRID_SIZE) {
                            if (grid[checkR][checkC].isShip) return false;
                        }
                    }
                }
            }
            return true;
        }

        function calculateNeighbors() {
            for (let r = 0; r < GRID_SIZE; r++) {
                for (let c = 0; c < GRID_SIZE; c++) {
                    if (grid[r][c].isShip) continue;
                    let count = 0;
                    for (let dr = -1; dr <= 1; dr++) {
                        for (let dc = -1; dc <= 1; dc++) {
                            const nr = r + dr, nc = c + dc;
                            if (nr >= 0 && nr < GRID_SIZE && nc >= 0 && nc < GRID_SIZE) {
                                if (grid[nr][nc].isShip) count++;
                            }
                        }
                    }
                    grid[r][c].neighborShips = count;
                }
            }
        }

        function renderGrid() {
            const container = document.getElementById('game-grid');
            if(!container) return;
            container.style.gridTemplateColumns = `repeat(${GRID_SIZE}, 1fr)`;
            container.innerHTML = '';
            for (let r = 0; r < GRID_SIZE; r++) {
                for (let c = 0; c < GRID_SIZE; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell border border-slate-800/40 flex items-center justify-center font-bold cell-hidden';
                    cell.id = `cell-${r}-${c}`;
                    cell.onclick = () => handleCellClick(r, c);
                    container.appendChild(cell);
                }
            }
        }

        function handleCellClick(r, c) {
            if (!gameActive) return;
            const data = grid[r][c];
            const isJammed = currentWeather === 'Electrical Storm' && selectedSub !== 'Ghost-6';
            if (currentMode === 'sonar') {
                if (data.revealed || isJammed) return;
                performSonar(r, c);
            } else if (currentMode === 'torpedo' || currentMode === 'buster') {
                pendingTorpedoOrigin = {r, c};
                const selector = document.getElementById('dir-selector');
                const vectorText = document.getElementById('target-vector-text');
                if(selector) selector.classList.remove('hidden');
                if(vectorText) vectorText.innerText = currentMode === 'buster' ? "BUSTER VECTOR" : "TORPEDO VECTOR";
            } else {
                if (data.revealed) return;
                revealCell(r, c);
                shots--;
                weatherCounter--;
                if (weatherCounter <= 0) changeWeather();
                checkGameOver();
                updateUI();
            }
        }

        function changeWeather() {
            currentWeather = nextWeather;
            nextWeather = WEATHER_TYPES[Math.floor(Math.random() * WEATHER_TYPES.length)];
            weatherCounter = 10;
            isGlobalFog = (currentWeather === 'Dense Fog');
            renderWeatherEffects();
        }

        function renderWeatherEffects() {
            document.querySelectorAll('.fog-overlay').forEach(el => el.remove());
            if (isGlobalFog) {
                for(let r=0; r<GRID_SIZE; r++) {
                    for(let c=0; c<GRID_SIZE; c++) {
                        const cell = document.getElementById(`cell-${r}-${c}`);
                        if(cell) {
                            const fog = document.createElement('div');
                            fog.className = 'fog-overlay';
                            cell.appendChild(fog);
                        }
                    }
                }
            }
            for(let r=0; r<GRID_SIZE; r++) {
                for(let c=0; c<GRID_SIZE; c++) {
                    const data = grid[r][c];
                    if (data.revealed && !data.isShip) {
                        const cellEl = document.getElementById(`cell-${r}-${c}`);
                        if (cellEl && data.neighborShips > 0) {
                            const isObscured = isGlobalFog && selectedSub !== 'Ghost-6';
                            cellEl.innerText = isObscured ? '?' : data.neighborShips;
                            cellEl.style.color = isObscured ? '#94a3b8' : getNumberColor(data.neighborShips);
                        }
                    }
                }
            }
        }

        function revealCell(r, c, isFree = false) {
            if (r < 0 || r >= GRID_SIZE || c < 0 || c >= GRID_SIZE) return;
            const data = grid[r][c];
            if (data.revealed) return;
            data.revealed = true;
            const cellEl = document.getElementById(`cell-${r}-${c}`);
            if(cellEl) cellEl.classList.remove('cell-hidden');
            if (data.isShip) {
                hits++;
                if(cellEl) {
                    cellEl.classList.add('cell-revealed-ship');
                    cellEl.innerHTML = 'ðŸ’¥';
                }
                const ship = shipData[data.shipId];
                ship.health--;
                if (ship.size === 3 && !isFree) revealRandomWater(3);
                if (ship.health <= 0) sinkShip(ship);
            } else {
                if(cellEl) cellEl.classList.add('cell-revealed-water');
                if (data.neighborShips > 0 && cellEl) {
                    const isObscured = isGlobalFog && selectedSub !== 'Ghost-6';
                    cellEl.innerText = isObscured ? '?' : data.neighborShips;
                    cellEl.style.color = isObscured ? '#94a3b8' : getNumberColor(data.neighborShips);
                }
            }
        }

        function revealRandomWater(count) {
            let revealed = 0; let attempts = 0;
            while (revealed < count && attempts < 100) {
                const r = Math.floor(Math.random() * GRID_SIZE);
                const c = Math.floor(Math.random() * GRID_SIZE);
                if (!grid[r][c].isShip && !grid[r][c].revealed) {
                    revealCell(r, c, true);
                    revealed++;
                }
                attempts++;
            }
        }

        function sinkShip(ship) {
            if (ship.isSunk) return;
            ship.isSunk = true;
            
            // Critical fix: Ensure hits count remaining health if buster triggered it
            const remainingHull = ship.health;
            if (remainingHull > 0) hits += remainingHull;
            ship.health = 0;

            const multiplier = selectedSub === 'The Scavenger' ? 2 : 1;
            if (ship.size === 2) { 
                shots += (5 * multiplier); 
                showStatusText(`+${5*multiplier} AMMO`, "text-emerald-400"); 
            }
            if (ship.size === 5) { 
                busterCharges += (1 * multiplier); 
                showStatusText(`${multiplier} BUSTER READY`, "text-red-400"); 
            }

            ship.coords.forEach(coord => {
                const el = document.getElementById(`cell-${coord.r}-${coord.c}`);
                if(el) {
                    el.classList.add('cell-sunk-ship');
                    el.innerHTML = 'âš“';
                    el.classList.remove('cell-hidden');
                }
                grid[coord.r][coord.c].revealed = true;
            });

            ship.coords.forEach(coord => {
                for (let dr = -1; dr <= 1; dr++) {
                    for (let dc = -1; dc <= 1; dc++) {
                        const nr = coord.r + dr, nc = coord.c + dc;
                        if (nr >= 0 && nr < GRID_SIZE && nc >= 0 && nc < GRID_SIZE) {
                            if (!grid[nr][nc].isShip) revealCell(nr, nc, true);
                        }
                    }
                }
            });
            checkGameOver(); updateUI();
        }

        function showStatusText(text, colorClass) {
            const statusText = document.getElementById('status-text');
            if (!statusText) return;
            statusText.innerText = text;
            statusText.className = `text-[9px] font-bold uppercase ${colorClass}`;
            setTimeout(() => { if (gameActive) { statusText.innerText = "READY"; statusText.className = "text-[9px] font-bold uppercase text-emerald-500"; } }, 3000);
        }

        function performSonar(r, c) {
            if (sonarCharges <= 0 || (currentWeather === 'Electrical Storm' && selectedSub !== 'Ghost-6')) return;
            sonarCharges--; cancelWeapon();
            for (let dr = -1; dr <= 1; dr++) {
                for (let dc = -1; dc <= 1; dc++) {
                    const nr = r + dr, nc = c + dc;
                    if (nr >= 0 && nr < GRID_SIZE && nc >= 0 && nc < GRID_SIZE) {
                        const cellEl = document.getElementById(`cell-${nr}-${nc}`);
                        const actualCellData = grid[nr][nc];
                        if(cellEl) cellEl.classList.add('cell-sonar');
                        setTimeout(() => {
                            if(cellEl) cellEl.classList.remove('cell-sonar');
                            if (actualCellData.isShip && cellEl) {
                                cellEl.innerHTML = '<span class="text-sm scale-110 drop-shadow-lg" style="color: #fbbf24; opacity: 1;">ðŸš¢</span>';
                            } else if (!actualCellData.revealed && cellEl) {
                                cellEl.innerHTML = '<span class="text-[10px] opacity-20">ðŸŒŠ</span>';
                            }
                        }, 1200);
                    }
                }
            }
            updateUI();
        }

        function fireTorpedoActual(dir) {
            const isBuster = (currentMode === 'buster');
            if (isBuster ? busterCharges <= 0 : torpedoCharges <= 0) return;
            isBuster ? busterCharges-- : torpedoCharges--;
            shots -= 2; 
            cancelWeapon();
            const {r, c} = pendingTorpedoOrigin;
            let currR = r, currC = c, hitTarget = false, path = [];
            while (currR >= 0 && currR < GRID_SIZE && currC >= 0 && currC < GRID_SIZE && !hitTarget) {
                path.push({r: currR, c: currC});
                if (grid[currR][currC].isShip) hitTarget = true;
                if (dir === 'up') currR--; else if (dir === 'down') currR++;
                else if (dir === 'left') currC--; else if (dir === 'right') currC++;
            }
            path.forEach((pos, index) => {
                setTimeout(() => {
                    const cellEl = document.getElementById(`cell-${pos.r}-${pos.c}`);
                    if(cellEl) cellEl.classList.add(isBuster ? 'cell-buster-path' : 'cell-torpedo-path');
                    setTimeout(() => {
                        if(cellEl) cellEl.classList.remove('cell-buster-path', 'cell-torpedo-path');
                        if (index === path.length - 1 && hitTarget) {
                            if (isBuster) {
                                sinkShip(shipData[grid[pos.r][pos.c].shipId]);
                            } else {
                                for (let dr = -1; dr <= 1; dr++) 
                                    for (let dc = -1; dc <= 1; dc++) 
                                        revealCell(pos.r + dr, pos.c + dc, true);
                            }
                        } else {
                            revealCell(pos.r, pos.c, true);
                        }
                        // Always check game state at the end of path animation
                        if (index === path.length - 1) { 
                            checkGameOver(); 
                            updateUI(); 
                        }
                    }, 150);
                }, index * 80);
            });
        }

        function getNumberColor(num) {
            const colors = ['', '#60a5fa', '#4ade80', '#fbbf24', '#f87171', '#c084fc', '#2dd4bf', '#f472b6', '#ffffff'];
            return colors[num] || '#fff';
        }

        function updateUI() {
            const shotsEl = document.getElementById('shots-count');
            const sonarEl = document.getElementById('sonar-count');
            const torpedoEl = document.getElementById('torpedo-count');
            const busterEl = document.getElementById('buster-count');
            const weatherEl = document.getElementById('weather-text');
            const nextWeatherEl = document.getElementById('next-weather');
            const sonarBtnEl = document.getElementById('sonar-btn');
            const busterBtnEl = document.getElementById('buster-btn');
            const fleetCountEl = document.getElementById('fleet-count');

            if(shotsEl) shotsEl.innerText = shots;
            if(sonarEl) sonarEl.innerText = sonarCharges;
            if(torpedoEl) torpedoEl.innerText = torpedoCharges;
            if(busterEl) busterEl.innerText = busterCharges;
            if(weatherEl) weatherEl.innerText = currentWeather;
            if(nextWeatherEl) nextWeatherEl.innerText = `Forecast: ${nextWeather} in ${weatherCounter}`;
            if(sonarBtnEl) sonarBtnEl.disabled = (currentWeather === 'Electrical Storm' && selectedSub !== 'Ghost-6') || sonarCharges <= 0;
            if(busterBtnEl) busterBtnEl.disabled = busterCharges <= 0;
            if(fleetCountEl) fleetCountEl.innerText = `${hits}/${totalShipSegments}`;

            const fleetDash = document.getElementById('fleet-dashboard');
            if(fleetDash) {
                fleetDash.innerHTML = '';
                shipData.forEach(ship => {
                    const shipContainer = document.createElement('div');
                    shipContainer.className = `ship-indicator ${ship.isSunk ? 'ship-sunk' : ''}`;
                    if (ship.size === 5) shipContainer.style.borderColor = '#ef444455';
                    for (let i = 0; i < ship.size; i++) {
                        const seg = document.createElement('div');
                        seg.className = 'ship-segment';
                        if (!ship.isSunk && i < (ship.size - ship.health)) seg.style.background = '#94a3b8';
                        shipContainer.appendChild(seg);
                    }
                    fleetDash.appendChild(shipContainer);
                });
            }
            if (shots < 8 && shotsEl) shotsEl.parentElement.classList.add('text-red-500', 'animate-pulse');
            else if(shotsEl) shotsEl.parentElement.classList.remove('text-red-500', 'animate-pulse');
        }

        function checkGameOver() {
            if (hits >= totalShipSegments) endGame(true);
            else if (shots <= 0 && gameActive) endGame(false);
        }

        function endGame(win) {
            gameActive = false;
            const overlay = document.getElementById('overlay');
            if(!overlay) return;
            overlay.classList.remove('hidden');
            const title = document.getElementById('overlay-title');
            const msg = document.getElementById('overlay-msg');
            const btn = document.getElementById('end-action-btn');
            
            if (win) {
                title.innerText = "VICTORY";
                title.className = "text-6xl font-black mb-4 text-emerald-500";
                msg.innerText = "Sector secured. Returning to strategic map.";
                btn.innerText = "Return to Overworld";
                btn.onclick = () => {
                    mapData[currentMissionPos.r][currentMissionPos.c] = 'visited';
                    // Clear previous current
                    for(let r=0; r<5; r++) for(let c=0; c<5; c++) if(mapData[r][c] === 'current') mapData[r][c] = 'visited';
                    playerPos = {r: currentMissionPos.r, c: currentMissionPos.c};
                    mapData[playerPos.r][playerPos.c] = 'current';
                    showScreen('overworld');
                    overlay.classList.add('hidden');
                };
            } else {
                title.innerText = "DEFEAT";
                title.className = "text-6xl font-black mb-4 text-red-600";
                msg.innerText = "Mission failure. Retreat to map for redeployment.";
                btn.innerText = "Retry Level";
                btn.onclick = () => {
                    overlay.classList.add('hidden');
                    startMission();
                };
            }
            // Reveal remaining
            for(let r=0; r<GRID_SIZE; r++) {
                for(let c=0; c<GRID_SIZE; c++) {
                    const cellEl = document.getElementById(`cell-${r}-${c}`);
                    const data = grid[r][c];
                    if (cellEl && !data.revealed && data.isShip) {
                        cellEl.classList.remove('cell-hidden');
                        cellEl.classList.add('bg-slate-700/50');
                        cellEl.innerHTML = 'ðŸš¢';
                    }
                }
            }
        }

        function cancelWeapon() {
            currentMode = 'shoot';
            const sonarBtn = document.getElementById('sonar-btn');
            const torpBtn = document.getElementById('torpedo-btn');
            const busterBtn = document.getElementById('buster-btn');
            const selector = document.getElementById('dir-selector');
            const statusText = document.getElementById('status-text');

            if(sonarBtn) sonarBtn.classList.remove('weapon-active');
            if(torpBtn) torpBtn.classList.remove('weapon-active');
            if(busterBtn) busterBtn.classList.remove('weapon-active');
            if(selector) selector.classList.add('hidden');
            if(statusText) {
                statusText.innerText = "READY";
                statusText.className = "text-[9px] font-bold text-emerald-500 uppercase";
            }
            updateUI();
        }

        window.onload = initGame;
    </script>
</body>
</html>
